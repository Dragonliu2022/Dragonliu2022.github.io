<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top">
  
  
  <title>操作系统实验 | Dragon&#39;s Blogs</title>
  <meta name="description" content="考试  多线程+多进程api使用 scanf不用，不用格式化输出 时间段提交特定题目 自己电脑    Task 1 熟悉Linux 详见博客 Linux操作手册  Task 2 文件读写  2.1 echo  myecho.c的功能与系统echo程序相同 接受命令行参数，并将参数打印出来 运行程序后前面出现./myecho  argc 是指传入参数的个数， argv[] 是一个指针数组，指向传递">
<meta property="og:type" content="article">
<meta property="og:title" content="操作系统实验">
<meta property="og:url" content="https://Dragonliu2018.github.io/2021/04/05/操作系统实验/index.html">
<meta property="og:site_name" content="Dragon Liu">
<meta property="og:description" content="考试  多线程+多进程api使用 scanf不用，不用格式化输出 时间段提交特定题目 自己电脑    Task 1 熟悉Linux 详见博客 Linux操作手册  Task 2 文件读写  2.1 echo  myecho.c的功能与系统echo程序相同 接受命令行参数，并将参数打印出来 运行程序后前面出现./myecho  argc 是指传入参数的个数， argv[] 是一个指针数组，指向传递">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-06-25_23-25-39.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/20190917221359663.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_15-41-06.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_15-42-26.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_16-41-10.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_17-41-36.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_17-42-17.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_23-51-54.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_15-52-50.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/215522854f166f7b5a537ccfa641c922_r.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/v2-9702bee4c343bce3289401dce83211c0_r.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/QQ图片20210523195240.jpg">
<meta property="og:updated_time" content="2022-04-18T16:43:24.623Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="操作系统实验">
<meta name="twitter:description" content="考试  多线程+多进程api使用 scanf不用，不用格式化输出 时间段提交特定题目 自己电脑    Task 1 熟悉Linux 详见博客 Linux操作手册  Task 2 文件读写  2.1 echo  myecho.c的功能与系统echo程序相同 接受命令行参数，并将参数打印出来 运行程序后前面出现./myecho  argc 是指传入参数的个数， argv[] 是一个指针数组，指向传递">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-06-25_23-25-39.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://Dragonliu2018.github.io/2021/04/05/操作系统实验/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Dragon Liu" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link href="//cdn.jsdelivr.net/npm/katex@0.9.0/dist/katex.min.css" rel="stylesheet">
  
  
  
  
</head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/dragonliu2018" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Dragon&#39;s Blogs</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Nuaa CSer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Nanjing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/dragonliu2018" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</br>dragonliu2018@gmail.com</br>电脑端观看效果更佳！</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">41</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/影视/">影视</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/未分类/">未分类</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/爬虫/">爬虫</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/环境与工具/">环境与工具</a><span class="category-list-count">34</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计组/">计组</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/阅读/">阅读</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/音乐/">音乐</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CV/">CV</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/">Crypto</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Element/">Element</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IT书籍/">IT书籍</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-Boot/">Spring Boot</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WP/">WP</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/neo4j/">neo4j</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/selenium/">selenium</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/书评/">书评</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/区块链/">区块链</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/待补充/">待补充</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/摘抄/">摘抄</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/深度学习/">深度学习</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/电影/">电影</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/电视剧/">电视剧</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/纪录片/">纪录片</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/重构/">重构</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面试/">面试</a><span class="tag-list-count">6</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/CV/" style="font-size: 13px;">CV</a> <a href="/tags/Crypto/" style="font-size: 13.14px;">Crypto</a> <a href="/tags/Element/" style="font-size: 13.71px;">Element</a> <a href="/tags/Git/" style="font-size: 13.71px;">Git</a> <a href="/tags/Hexo/" style="font-size: 13.43px;">Hexo</a> <a href="/tags/IT书籍/" style="font-size: 13px;">IT书籍</a> <a href="/tags/MySQL/" style="font-size: 13.71px;">MySQL</a> <a href="/tags/Redis/" style="font-size: 13px;">Redis</a> <a href="/tags/Spring-Boot/" style="font-size: 13.14px;">Spring Boot</a> <a href="/tags/Vue/" style="font-size: 13px;">Vue</a> <a href="/tags/WP/" style="font-size: 13.29px;">WP</a> <a href="/tags/Web/" style="font-size: 13.14px;">Web</a> <a href="/tags/neo4j/" style="font-size: 13px;">neo4j</a> <a href="/tags/selenium/" style="font-size: 13.14px;">selenium</a> <a href="/tags/书评/" style="font-size: 13.86px;">书评</a> <a href="/tags/区块链/" style="font-size: 13px;">区块链</a> <a href="/tags/待补充/" style="font-size: 14px;">待补充</a> <a href="/tags/摘抄/" style="font-size: 13.14px;">摘抄</a> <a href="/tags/深度学习/" style="font-size: 13.14px;">深度学习</a> <a href="/tags/电影/" style="font-size: 13.29px;">电影</a> <a href="/tags/电视剧/" style="font-size: 13px;">电视剧</a> <a href="/tags/纪录片/" style="font-size: 13px;">纪录片</a> <a href="/tags/重构/" style="font-size: 13.43px;">重构</a> <a href="/tags/面试/" style="font-size: 13.57px;">面试</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">43</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">23</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a><span class="archive-list-count">34</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/计组/">计组</a>
              </p>
              <p class="item-title">
                <a href="/2022/06/05/Lab3实验总结/" class="title">Lab3实验总结</a>
              </p>
              <p class="item-date">
                <time datetime="2022-06-05T12:52:07.000Z" itemprop="datePublished">2022-06-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2022/05/29/Java中调用Python程序/" class="title">Java中调用Python程序</a>
              </p>
              <p class="item-date">
                <time datetime="2022-05-29T14:28:07.000Z" itemprop="datePublished">2022-05-29</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/环境与工具/">环境与工具</a>
              </p>
              <p class="item-title">
                <a href="/2022/05/27/gdb调试/" class="title">gdb调试</a>
              </p>
              <p class="item-date">
                <time datetime="2022-05-27T05:24:18.000Z" itemprop="datePublished">2022-05-27</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/计组/">计组</a>
              </p>
              <p class="item-title">
                <a href="/2022/05/27/PA答疑之a4指令码报错/" class="title">PA答疑之a4指令码报错</a>
              </p>
              <p class="item-date">
                <time datetime="2022-05-27T05:06:36.000Z" itemprop="datePublished">2022-05-27</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/计组/">计组</a>
              </p>
              <p class="item-title">
                <a href="/2022/05/26/64位Ubuntu运行32位程序/" class="title">64位Ubuntu运行或调试32位程序</a>
              </p>
              <p class="item-date">
                <time datetime="2022-05-26T05:20:32.000Z" itemprop="datePublished">2022-05-26</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#考试"><span class="toc-number">1.</span> <span class="toc-text"> 考试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#task-1-熟悉linux"><span class="toc-number">2.</span> <span class="toc-text"> Task 1 熟悉Linux</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#task-2-文件读写"><span class="toc-number">3.</span> <span class="toc-text"> Task 2 文件读写</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#21-echo"><span class="toc-number">3.1.</span> <span class="toc-text"> 2.1 echo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-cat"><span class="toc-number">3.2.</span> <span class="toc-text"> 2.2 cat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-cp"><span class="toc-number">3.3.</span> <span class="toc-text"> 2.3 cp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#task-3-多进程题目"><span class="toc-number">4.</span> <span class="toc-text"> Task 3+ 多进程题目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#31-mysys-task3"><span class="toc-number">4.1.</span> <span class="toc-text"> 3.1 mysys (Task3)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#32-sh1c-task4"><span class="toc-number">4.2.</span> <span class="toc-text"> 3.2 sh1.c (Task4)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#33-sh2c-task5"><span class="toc-number">4.3.</span> <span class="toc-text"> 3.3 sh2.c (Task5)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#34-sh3c-task6"><span class="toc-number">4.4.</span> <span class="toc-text"> 3.4 sh3.c (Task6)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#task-7-多线程题目"><span class="toc-number">5.</span> <span class="toc-text"> Task 7+ 多线程题目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#71-pi1c-task7"><span class="toc-number">5.1.</span> <span class="toc-text"> 7.1 pi1.c (Task7)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#72-pi2c-task7"><span class="toc-number">5.2.</span> <span class="toc-text"> 7.2  pi2.c (Task7)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#73-sortctask-8"><span class="toc-number">5.3.</span> <span class="toc-text"> 7.3 sort.c(Task 8)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#74-pc1ctask-9"><span class="toc-number">5.4.</span> <span class="toc-text"> 7.4 pc1.c(Task 9)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#75-pc2ctask-10"><span class="toc-number">5.5.</span> <span class="toc-text"> 7.5 pc2.c(Task 10)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#task-11考试"><span class="toc-number">6.</span> <span class="toc-text"> Task 11+考试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#112-ringc"><span class="toc-number">6.1.</span> <span class="toc-text"> 11.2 ring.c</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#112-多消费者多生产者"><span class="toc-number">6.2.</span> <span class="toc-text"> 11.2 多消费者+多生产者</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#随堂作业"><span class="toc-number">7.</span> <span class="toc-text"> 随堂作业</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#todo-1-进程的内存布局"><span class="toc-number">7.1.</span> <span class="toc-text"> Todo 1 进程的内存布局</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#要求"><span class="toc-number">7.1.1.</span> <span class="toc-text"> 要求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#理论基础"><span class="toc-number">7.1.2.</span> <span class="toc-text"> 理论基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#源代码"><span class="toc-number">7.1.3.</span> <span class="toc-text"> 源代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#运行结果"><span class="toc-number">7.1.4.</span> <span class="toc-text"> 运行结果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#linuxubuntu-18042-lts"><span class="toc-number">7.1.4.1.</span> <span class="toc-text"> Linux(Ubuntu 18.04.2 LTS)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#windows-10"><span class="toc-number">7.1.4.2.</span> <span class="toc-text"> Windows 10</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#macos"><span class="toc-number">7.1.4.3.</span> <span class="toc-text"> macOS</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">7.1.5.</span> <span class="toc-text"> 总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-number">7.1.6.</span> <span class="toc-text"> 参考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#todo-2-进程相关"><span class="toc-number">7.2.</span> <span class="toc-text"> Todo 2 进程相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一-选择题"><span class="toc-number">7.2.1.</span> <span class="toc-text"> 一、选择题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二-概念理解及应用"><span class="toc-number">7.2.2.</span> <span class="toc-text"> 二、概念理解及应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#t14分"><span class="toc-number">7.2.2.1.</span> <span class="toc-text"> T1(4分)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#t24分"><span class="toc-number">7.2.2.2.</span> <span class="toc-text"> T2(4分)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三-计算题"><span class="toc-number">7.2.3.</span> <span class="toc-text"> 三、计算题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#todo-3"><span class="toc-number">7.3.</span> <span class="toc-text"> Todo 3</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-操作系统实验" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      操作系统实验
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2021/04/05/操作系统实验/" class="article-date">
	  <time datetime="2021-04-05T13:10:33.000Z" itemprop="datePublished">2021-04-05</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/OS/">OS</a>
  </span>

        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/04/05/操作系统实验/#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 10.1k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 49(分)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="考试"><a class="markdownIt-Anchor" href="#考试"></a> 考试</h1>
<ul>
<li>多线程+多进程api使用</li>
<li>scanf不用，不用格式化输出</li>
<li>时间段提交特定题目</li>
<li>自己电脑</li>
<li></li>
</ul>
<h1 id="task-1-熟悉linux"><a class="markdownIt-Anchor" href="#task-1-熟悉linux"></a> Task 1 熟悉Linux</h1>
<p>详见博客 <code>Linux操作手册</code></p>
<h1 id="task-2-文件读写"><a class="markdownIt-Anchor" href="#task-2-文件读写"></a> Task 2 文件读写</h1>
<h2 id="21-echo"><a class="markdownIt-Anchor" href="#21-echo"></a> 2.1 echo</h2>
<ul>
<li>myecho.c的功能与系统echo程序相同</li>
<li>接受命令行参数，并将参数打印出来</li>
<li><strong>运行程序后前面出现<code>./myecho</code></strong>
<ul>
<li><strong>argc</strong> 是指传入参数的个数，</li>
<li><strong>argv[]</strong> 是一个指针数组，指向传递给程序的每个参数。第一个参数就是<code>./myecho</code>，所以从第二个参数开始打印即可。</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[] )</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( argc == <span class="number">0</span>  )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>( <span class="keyword">int</span> i=<span class="number">1</span>; i&lt;argc; i++ )&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%s "</span>, argv[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="22-cat"><a class="markdownIt-Anchor" href="#22-cat"></a> 2.2 cat</h2>
<ul>
<li>mycat.c的功能与系统cat程序相同</li>
<li>mycat将指定的文件内容输出到屏幕，例子如下：</li>
<li>要求使用系统调用open/read/write/close实现</li>
<li><strong>TODO</strong>
<ul>
<li>文件内容超出maxn</li>
<li>cat+空格命令</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[] )</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( argc == <span class="number">0</span>  )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>( <span class="keyword">int</span> i=<span class="number">1</span>; i&lt;argc; i++ )&#123;</span><br><span class="line">            <span class="keyword">int</span> fd = <span class="built_in">open</span>(argv[i], O_RDONLY);<span class="comment">//只读</span></span><br><span class="line">            <span class="keyword">if</span>( fd==<span class="number">-1</span> )&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"mycat: %s: No such file or directory\n"</span>, argv[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">char</span> *buf;</span><br><span class="line">                <span class="keyword">int</span> maxn = <span class="number">10000</span>;<span class="comment">//接受最大字符数</span></span><br><span class="line">                buf = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(maxn);</span><br><span class="line">                <span class="keyword">int</span> rd = <span class="built_in">read</span>(fd, buf, maxn);</span><br><span class="line">                <span class="keyword">if</span>( rd==<span class="number">-1</span> )&#123;<span class="comment">//读取失败</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"Read failed!\n"</span>);</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>( rd==<span class="number">0</span> )&#123;<span class="comment">//读取到了文件末尾</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;<span class="comment">//正常读取</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%s"</span>, buf);</span><br><span class="line">                    <span class="built_in">close</span>(fd);<span class="comment">//关闭文件</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="23-cp"><a class="markdownIt-Anchor" href="#23-cp"></a> 2.3 cp</h2>
<ul>
<li>mycp.c的功能与系统cp程序相同</li>
<li>将源文件复制到目标文件，例子如下：</li>
<li>要求使用系统调用open/read/write/close实现</li>
<li><strong>TODO</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[] )</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( argc == <span class="number">0</span>  )&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( argc == <span class="number">1</span> )&#123;<span class="comment">//无文件参数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"mycp: missing file operand\nTry 'cp --help' for more information.\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( argc == <span class="number">2</span> )&#123;<span class="comment">//只有1个文件参数</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"mycp: missing destination file operand after '%s'\n"</span>, argv[<span class="number">1</span>]); </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Try 'cp --help' for more information.\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( argc == <span class="number">3</span> )&#123;<span class="comment">//2个文件参数</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], argv[<span class="number">2</span>]) == <span class="number">0</span> )&#123;<span class="comment">//文件名相同</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"mycp: '%s' and '%s' are the same file\n"</span>, argv[<span class="number">1</span>], argv[<span class="number">2</span>]);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> s_fd = <span class="built_in">open</span>(argv[<span class="number">1</span>], O_RDONLY);<span class="comment">//源文件-只读</span></span><br><span class="line">        <span class="keyword">if</span>( s_fd==<span class="number">-1</span> )&#123;<span class="comment">//文件不存在</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"mycp: cannot stat '%s': No such file or directory\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">int</span> t_fd = <span class="built_in">open</span>(argv[<span class="number">2</span>], O_RDWR | O_TRUNC | O_CREAT);<span class="comment">//目标文件-创建+截断+读写</span></span><br><span class="line">            <span class="keyword">char</span> *buf;</span><br><span class="line">            <span class="keyword">int</span> maxn = <span class="number">10000</span>;<span class="comment">//接受最大字符数</span></span><br><span class="line">            buf = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(maxn);</span><br><span class="line">            <span class="keyword">int</span> s_rd = <span class="built_in">read</span>(s_fd, buf, maxn);</span><br><span class="line">            <span class="keyword">if</span>( s_rd==<span class="number">-1</span> )&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Read failed!\n"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// printf("%s", buf);</span></span><br><span class="line">                <span class="keyword">int</span> t_we = <span class="built_in">write</span>(t_fd, buf, <span class="built_in">strlen</span>(buf));<span class="comment">//缓冲区大小</span></span><br><span class="line">                <span class="keyword">if</span>( t_we==<span class="number">-1</span> )&#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"Write failed!\n"</span>);</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//关闭文件</span></span><br><span class="line">            <span class="built_in">close</span>(s_fd);</span><br><span class="line">            <span class="built_in">close</span>(t_fd);</span><br><span class="line">            <span class="comment">//新建的文件加权限</span></span><br><span class="line">            chmod(argv[<span class="number">2</span>], S_IRUSR|S_IWUSR|S_IXUSR|S_IRGRP|S_IWGRP|S_IXGRP|S_IROTH|S_IWOTH|S_IXOTH);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"TODO\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="task-3-多进程题目"><a class="markdownIt-Anchor" href="#task-3-多进程题目"></a> Task 3+ 多进程题目</h1>
<h2 id="31-mysys-task3"><a class="markdownIt-Anchor" href="#31-mysys-task3"></a> 3.1 mysys (Task3)</h2>
<ul>
<li>mysys的功能与系统函数system相同，要求用进程管理相关系统调用自己实现一遍</li>
<li><strong>使用fork/exec/wait系统调用实现mysys</strong></li>
<li>不能通过调用系统函数system实现mysys</li>
</ul>
<blockquote>
<p><strong>题外话</strong>：vscode直接运行代码的话会出现问题，<code>---------</code>会在最后输出，在命令行运行并没问题。目前原因还不知道</p>
<p><strong>5月15日</strong>：在实现Task5时发现功能已经具备，这才察觉到Task3写错了，原来使用<code>execl(&quot;/bin/sh&quot;, &quot;sh&quot;, &quot;-c&quot;, command, NULL);</code>，其实这与调用系统函数system无异。第一个参数应该指定可命令的路径，而不是直接指定sh。</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> max_argc = <span class="number">100</span>;<span class="comment">//命令参数最大数量</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mysys</span><span class="params">(<span class="keyword">char</span> *command)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 实现该函数，该函数执行一条命令，并等待该命令执行结束 */</span></span><br><span class="line">    <span class="comment">// 命令为空</span></span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Command is a null string!"</span>);</span><br><span class="line">        <span class="keyword">return</span> ; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 命令不为空</span></span><br><span class="line">    <span class="keyword">char</span> copy_command[<span class="built_in">strlen</span>(command) + <span class="number">1</span>];<span class="comment">//command的副本，避免影响传进来的参数</span></span><br><span class="line">    <span class="built_in">strcpy</span>(copy_command, command);</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid = fork();<span class="comment">//创建子进程</span></span><br><span class="line">    <span class="keyword">char</span> *argv[max_argc];<span class="comment">//命令参数列表</span></span><br><span class="line">    <span class="keyword">char</span> *tmp_arg;<span class="comment">//切割字符串的临时变量</span></span><br><span class="line">    <span class="keyword">int</span> argc = <span class="number">0</span>;<span class="comment">//命令参数数量</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// execl("/bin/sh", "sh", "-c", command, NULL);</span></span><br><span class="line">        <span class="comment">//分割字符串</span></span><br><span class="line">        tmp_arg = strtok(copy_command, <span class="string">" "</span>);</span><br><span class="line">        argv[argc++] = tmp_arg;</span><br><span class="line">        <span class="keyword">while</span> (tmp_arg &amp;&amp; argc &lt;= max_argc) &#123;</span><br><span class="line">            tmp_arg = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">            argv[argc++] = tmp_arg;</span><br><span class="line">        &#125;</span><br><span class="line">        argv[argc] = <span class="literal">NULL</span>;<span class="comment">//将最后一项设置为NULL指针</span></span><br><span class="line">        execvp(argv[<span class="number">0</span>], argv);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE); <span class="comment">// exec执行失败返回EXIT_FAILURE，执行成功这句就不执行</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">//父进程</span></span><br><span class="line">        wait(<span class="literal">NULL</span>);<span class="comment">//等待子进程结束</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"--------------------------------------------------\n"</span>);</span><br><span class="line">    mysys(<span class="string">"echo HELLO WORLD"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"--------------------------------------------------\n"</span>);</span><br><span class="line">    mysys(<span class="string">"ls /"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"--------------------------------------------------\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="32-sh1c-task4"><a class="markdownIt-Anchor" href="#32-sh1c-task4"></a> 3.2 sh1.c (Task4)</h2>
<ul>
<li>该程序读取用户输入的命令，调用函数mysys(上一个作业)执行用户的命令</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> max_argc = <span class="number">100</span>;<span class="comment">//命令参数最大数量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mysys.c实现的作业 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mysys</span><span class="params">(<span class="keyword">char</span> *command)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 实现该函数，该函数执行一条命令，并等待该命令执行结束 */</span></span><br><span class="line">    <span class="comment">// 命令为空</span></span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Command is a null string!"</span>);</span><br><span class="line">        <span class="keyword">return</span> ; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 命令不为空</span></span><br><span class="line">    <span class="keyword">char</span> copy_command[<span class="built_in">strlen</span>(command) + <span class="number">1</span>];<span class="comment">//command的副本，避免影响传进来的参数</span></span><br><span class="line">    <span class="built_in">strcpy</span>(copy_command, command);</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid = fork();<span class="comment">//创建子进程</span></span><br><span class="line">    <span class="keyword">char</span> *argv[max_argc];<span class="comment">//命令参数列表</span></span><br><span class="line">    <span class="keyword">char</span> *tmp_arg;<span class="comment">//切割字符串的临时变量</span></span><br><span class="line">    <span class="keyword">int</span> argc = <span class="number">0</span>;<span class="comment">//命令参数数量</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// execl("/bin/sh", "sh", "-c", command, NULL);</span></span><br><span class="line">        <span class="comment">//分割字符串</span></span><br><span class="line">        tmp_arg = strtok(copy_command, <span class="string">" "</span>);</span><br><span class="line">        argv[argc++] = tmp_arg;</span><br><span class="line">        <span class="keyword">while</span> (tmp_arg &amp;&amp; argc &lt;= max_argc) &#123;</span><br><span class="line">            tmp_arg = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">            argv[argc++] = tmp_arg;</span><br><span class="line">        &#125;</span><br><span class="line">        argv[argc] = <span class="literal">NULL</span>;<span class="comment">//将最后一项设置为NULL指针</span></span><br><span class="line">        execvp(argv[<span class="number">0</span>], argv);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE); <span class="comment">// exec执行失败返回EXIT_FAILURE，执行成功这句就不执行</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">//父进程</span></span><br><span class="line">        wait(<span class="literal">NULL</span>);<span class="comment">//等待子进程结束</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;<span class="comment">//循环输入</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">1000</span>;<span class="comment">//最长命令字符数</span></span><br><span class="line">        <span class="keyword">char</span> cmd[maxn];<span class="comment">//命令</span></span><br><span class="line">        <span class="comment">// gets(cmd);</span></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%[^\n]%*c"</span>, cmd);<span class="comment">//替代gets</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cmd, <span class="string">"exit"</span>) == <span class="number">0</span>) &#123;<span class="comment">//终止sh</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mysys(cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="33-sh2c-task5"><a class="markdownIt-Anchor" href="#33-sh2c-task5"></a> 3.3 sh2.c (Task5)</h2>
<ul>
<li>实现shell程序，要求在第1版的基础上，添加如下功能：<strong>实现文件重定向</strong></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;//open</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> max_argc = <span class="number">100</span>;<span class="comment">//命令参数最大数量</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mysys</span><span class="params">(<span class="keyword">char</span> *command)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 实现该函数，该函数执行一条命令，并等待该命令执行结束 */</span></span><br><span class="line">    <span class="comment">// 命令为空</span></span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Command is a null string!"</span>);</span><br><span class="line">        <span class="keyword">return</span> ; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 命令不为空，将命令分为两部分</span></span><br><span class="line">    <span class="keyword">char</span> *cmd1, *cmd2;</span><br><span class="line">    cmd1 = strtok(command, <span class="string">"&gt;"</span>);</span><br><span class="line">    cmd2 = strtok(<span class="literal">NULL</span>, <span class="string">"&gt;"</span>);</span><br><span class="line">    <span class="keyword">char</span> copy_command[<span class="built_in">strlen</span>(cmd1) + <span class="number">1</span>];<span class="comment">//command的副本，避免影响传进来的参数</span></span><br><span class="line">    <span class="built_in">strcpy</span>(copy_command, cmd1);</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid = fork();<span class="comment">//创建子进程</span></span><br><span class="line">    <span class="keyword">char</span> *argv[max_argc];<span class="comment">//命令参数列表</span></span><br><span class="line">    <span class="keyword">char</span> *tmp_arg;<span class="comment">//切割字符串的临时变量</span></span><br><span class="line">    <span class="keyword">int</span> argc = <span class="number">0</span>;<span class="comment">//命令参数数量</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// execl("/bin/sh", "sh", "-c", command, NULL);</span></span><br><span class="line">        <span class="comment">// 分割cmd1字符串</span></span><br><span class="line">        tmp_arg = strtok(copy_command, <span class="string">" "</span>);</span><br><span class="line">        argv[argc++] = tmp_arg;</span><br><span class="line">        <span class="keyword">while</span> (tmp_arg &amp;&amp; argc &lt;= max_argc) &#123;</span><br><span class="line">            tmp_arg = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">            argv[argc++] = tmp_arg;</span><br><span class="line">        &#125;</span><br><span class="line">        argv[argc] = <span class="literal">NULL</span>;<span class="comment">//将最后一项设置为NULL指针</span></span><br><span class="line">        <span class="comment">// 重定向至cmd2所指的文件</span></span><br><span class="line">        <span class="keyword">if</span> (cmd2) &#123;</span><br><span class="line">            <span class="keyword">int</span> fd;</span><br><span class="line">            fd = <span class="built_in">open</span>(cmd2, O_CREAT|O_RDWR, <span class="number">0666</span>); </span><br><span class="line">            dup2(fd, <span class="number">1</span>); </span><br><span class="line">            <span class="built_in">close</span>(fd);</span><br><span class="line">        &#125;</span><br><span class="line">        execvp(argv[<span class="number">0</span>], argv);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE); <span class="comment">// exec执行失败返回EXIT_FAILURE，执行成功这句就不执行</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">//父进程</span></span><br><span class="line">        wait(<span class="literal">NULL</span>);<span class="comment">//等待子进程结束</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;<span class="comment">//循环输入</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">1000</span>;<span class="comment">//最长命令字符数</span></span><br><span class="line">        <span class="keyword">char</span> cmd[maxn];<span class="comment">//命令</span></span><br><span class="line">        <span class="comment">// gets(cmd);</span></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%[^\n]%*c"</span>, cmd);<span class="comment">//替代gets</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cmd, <span class="string">"exit"</span>) == <span class="number">0</span>) &#123;<span class="comment">//终止sh</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mysys(cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="34-sh3c-task6"><a class="markdownIt-Anchor" href="#34-sh3c-task6"></a> 3.4 sh3.c (Task6)</h2>
<p>实现shell程序，要求在第2版的基础上，添加如下功能：</p>
<ul>
<li>实现管道</li>
<li>只要求连接两个命令，不要求连接多个命令</li>
<li>不要求同时处理管道和重定向</li>
<li>考虑如何实现管道和文件重定向，暂不做强制要求</li>
</ul>
<blockquote>
<p>此次作业遇到诸多问题，消费时间过长，主要是要静下来、沉下来，问题如下：</p>
<ol>
<li>strtok返回参数问题：返回值无法打印复制等，报<code>segmentation fault</code>错误，	需要加个头文件<code>#include &lt;string.h&gt;</code></li>
<li>pipe要在fork之前</li>
<li>初步实现的代码执行完<code>cat /etc/passwd | wc -l</code>后就立马退出程序，不知道是什么原因</li>
</ol>
<p>为实现进阶功能，后续打算参考<code>MIT6.828 homework2：shell</code>进行实现。参考：</p>
<ul>
<li><a href="https://www.linuxmooc.com/T/sh3-hint.pdf" target="_blank" rel="noopener">https://www.linuxmooc.com/T/sh3-hint.pdf</a></li>
<li><a href="https://www.linuxmooc.com/courses/fd/" target="_blank" rel="noopener">https://www.linuxmooc.com/courses/fd/</a></li>
<li><a href="https://blog.csdn.net/a747979985/article/details/95094094" target="_blank" rel="noopener">https://blog.csdn.net/a747979985/article/details/95094094</a></li>
</ul>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;//open</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> max_argc = <span class="number">100</span>;<span class="comment">//命令参数最大数量</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">1000</span>;<span class="comment">//最长命令字符数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mysys</span><span class="params">(<span class="keyword">char</span> *command)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 实现该函数，该函数执行一条命令，并等待该命令执行结束 */</span></span><br><span class="line">    <span class="comment">// 命令为空</span></span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Command is a null string!"</span>);</span><br><span class="line">        <span class="keyword">return</span> ; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 命令不为空，将命令分为两部分</span></span><br><span class="line">    <span class="keyword">char</span> *cmd1 = <span class="literal">NULL</span>, *cmd2 = <span class="literal">NULL</span>;</span><br><span class="line">    cmd1 = strtok(command, <span class="string">"|"</span>);</span><br><span class="line">    cmd2 = strtok(<span class="literal">NULL</span>, <span class="string">"|"</span>);</span><br><span class="line">    <span class="keyword">char</span> copy_cmd1[maxn];<span class="comment">//创建副本，避免影响传进来的参数</span></span><br><span class="line">    <span class="keyword">char</span> copy_cmd2[maxn];<span class="comment">//创建副本，避免影响传进来的参数</span></span><br><span class="line">    <span class="built_in">strcpy</span>(copy_cmd1, cmd1);</span><br><span class="line">    <span class="keyword">if</span> (cmd2)</span><br><span class="line">        <span class="built_in">strcpy</span>(copy_cmd2, cmd2);</span><br><span class="line">    <span class="comment">// printf("%s\n%s\n", copy_cmd1, copy_cmd2);</span></span><br><span class="line">    <span class="keyword">int</span> fd[<span class="number">2</span>];<span class="comment">//位置在创建子进程之前</span></span><br><span class="line">    pipe(fd);</span><br><span class="line">    <span class="keyword">char</span> *argv[max_argc];<span class="comment">//命令参数列表</span></span><br><span class="line">    <span class="keyword">char</span> *tmp_arg;<span class="comment">//切割字符串的临时变量</span></span><br><span class="line">    <span class="keyword">int</span> argc = <span class="number">0</span>;<span class="comment">//命令参数数量</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    pid = fork();<span class="comment">//创建子进程</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// execl("/bin/sh", "sh", "-c", command, NULL);</span></span><br><span class="line">        <span class="comment">// 分割cmd1字符串</span></span><br><span class="line">        tmp_arg = strtok(copy_cmd1, <span class="string">" "</span>);</span><br><span class="line">        argv[argc++] = tmp_arg;</span><br><span class="line">        <span class="keyword">while</span> (tmp_arg &amp;&amp; argc &lt;= max_argc) &#123;</span><br><span class="line">            tmp_arg = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">            argv[argc++] = tmp_arg;</span><br><span class="line">        &#125;</span><br><span class="line">        argv[argc] = <span class="literal">NULL</span>;<span class="comment">//将最后一项设置为NULL指针</span></span><br><span class="line">        <span class="comment">// 重定向至cmd2所指的文件</span></span><br><span class="line">        <span class="keyword">if</span> (cmd2) &#123;</span><br><span class="line">            dup2(fd[<span class="number">1</span>], <span class="number">1</span>); </span><br><span class="line">            <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        execvp(argv[<span class="number">0</span>], argv);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE); <span class="comment">// exec执行失败返回EXIT_FAILURE，执行成功这句就不执行</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">//父进程</span></span><br><span class="line">        <span class="keyword">if</span> (cmd2) &#123;</span><br><span class="line">            dup2(fd[<span class="number">0</span>], <span class="number">0</span>); </span><br><span class="line">            <span class="built_in">close</span>(fd[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">close</span>(fd[<span class="number">1</span>]);</span><br><span class="line">            <span class="comment">// 分割cmd2字符串</span></span><br><span class="line">            tmp_arg = strtok(copy_cmd2, <span class="string">" "</span>);</span><br><span class="line">            argv[argc++] = tmp_arg;</span><br><span class="line">            <span class="keyword">while</span> (tmp_arg &amp;&amp; argc &lt;= max_argc) &#123;</span><br><span class="line">                tmp_arg = strtok(<span class="literal">NULL</span>, <span class="string">" "</span>);</span><br><span class="line">                argv[argc++] = tmp_arg;</span><br><span class="line">            &#125;</span><br><span class="line">            argv[argc] = <span class="literal">NULL</span>;<span class="comment">//将最后一项设置为NULL指针</span></span><br><span class="line">            execvp(argv[<span class="number">0</span>], argv);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);<span class="comment">//等待子进程结束</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;<span class="comment">//循环输入</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"&gt; "</span>);</span><br><span class="line">        <span class="keyword">char</span> cmd[maxn];<span class="comment">//命令</span></span><br><span class="line">        <span class="comment">// gets(cmd);</span></span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%[^\n]%*c"</span>, cmd);<span class="comment">//替代gets</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cmd, <span class="string">"exit"</span>) == <span class="number">0</span>) &#123;<span class="comment">//终止sh</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mysys(cmd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* MIT6.828 homework2：shell */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Simplifed xv6 shell.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXARGS 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// All commands have at least a type. Have looked at the type, the code</span></span><br><span class="line"><span class="comment">// typically casts the *cmd to some specific cmd type.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cmd</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> type;  <span class="comment">//  ' ' (exec), | (pipe), '&lt;' or '&gt;' for redirection</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* 执行指令 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">execcmd</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> type;             <span class="comment">// ' '</span></span><br><span class="line">  <span class="keyword">char</span> *argv[MAXARGS];  <span class="comment">// arguments to the command to be exec-ed</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* 重定向指令 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redircmd</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> type;         <span class="comment">// &lt; or &gt;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cmd</span> *<span class="title">cmd</span>;</span>  <span class="comment">// the command to be run (e.g., an execcmd)</span></span><br><span class="line">  <span class="keyword">char</span> *file;       <span class="comment">// the input/output file</span></span><br><span class="line">  <span class="keyword">int</span> flags;        <span class="comment">// flags for open() indicating read or write</span></span><br><span class="line">  <span class="keyword">int</span> fd;           <span class="comment">// the file descriptor number to use for the file</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* 管道指令 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipecmd</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> type;           <span class="comment">// |</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cmd</span> *<span class="title">left</span>;</span>   <span class="comment">// left side of pipe</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cmd</span> *<span class="title">right</span>;</span>  <span class="comment">// right side of pipe</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fork1</span><span class="params">(<span class="keyword">void</span>)</span></span>;  <span class="comment">// Fork but exits on failure.</span></span><br><span class="line"><span class="function">struct cmd *<span class="title">parsecmd</span><span class="params">(<span class="keyword">char</span> *)</span></span>;</span><br><span class="line"><span class="comment">/* 执行指令 */</span></span><br><span class="line"><span class="comment">// Execute cmd.  Never returns.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">runcmd</span><span class="params">(struct cmd *cmd)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> p[<span class="number">2</span>], r;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">execcmd</span> *<span class="title">ecmd</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipecmd</span> *<span class="title">pcmd</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">redircmd</span> *<span class="title">rcmd</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (cmd == <span class="number">0</span>) _exit(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (cmd-&gt;type) &#123;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"unknown runcmd\n"</span>);</span><br><span class="line">      _exit(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">      ecmd = (struct execcmd *)cmd;</span><br><span class="line">      <span class="keyword">if</span> (ecmd-&gt;argv[<span class="number">0</span>] == <span class="number">0</span>) _exit(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//   fprintf(stderr, "exec not implemented\n");</span></span><br><span class="line">      <span class="comment">// Your code here ...</span></span><br><span class="line">      <span class="comment">/* 处理执行失败的指令 */</span></span><br><span class="line">      <span class="keyword">if</span> (execv(ecmd-&gt;argv[<span class="number">0</span>], ecmd-&gt;argv) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">char</span> mypath[<span class="number">20</span>] = <span class="string">"/bin/"</span>;</span><br><span class="line">        <span class="built_in">strcat</span>(mypath, ecmd-&gt;argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (execv(mypath, ecmd-&gt;argv) == <span class="number">-1</span>) &#123;</span><br><span class="line">          <span class="built_in">strcpy</span>(mypath, <span class="string">"/usr/bin/"</span>); </span><br><span class="line">          <span class="built_in">strcat</span>(mypath, ecmd-&gt;argv[<span class="number">0</span>]);</span><br><span class="line">          <span class="keyword">if</span> (execv(mypath, ecmd-&gt;argv) == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Command %s can't find\n"</span>, ecmd-&gt;argv[<span class="number">0</span>]);</span><br><span class="line">            _exit(<span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'&gt;'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'&lt;'</span>:</span><br><span class="line">    <span class="comment">// 利用fd的顺序增长的特性，使用close()关闭标准I/O的fd，然后open()打开目标文件，</span></span><br><span class="line">    <span class="comment">// 此时文件的fd就会自动替换我们关闭的标准I/O的fd，也就实现了重定向。</span></span><br><span class="line">      rcmd = (struct redircmd *)cmd;</span><br><span class="line">      <span class="built_in">close</span>(rcmd-&gt;fd);</span><br><span class="line">    <span class="comment">//   fprintf(stderr, "redir not implemented\n");</span></span><br><span class="line">      <span class="comment">// Your code here ...</span></span><br><span class="line">      <span class="comment">/* 处理重定向 */</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">open</span>(rcmd-&gt;file, rcmd-&gt;flags, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH) &lt;</span><br><span class="line">          <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"file %s can't find\n"</span>, rcmd-&gt;file);</span><br><span class="line">        _exit(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      runcmd(rcmd-&gt;cmd);<span class="comment">//递归</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'|'</span>:</span><br><span class="line">      pcmd = (struct pipecmd *)cmd;</span><br><span class="line">    <span class="comment">//   fprintf(stderr, "pipe not implemented\n");</span></span><br><span class="line">      <span class="comment">// Your code here ...</span></span><br><span class="line">      <span class="comment">/* 处理管道 */</span></span><br><span class="line">      <span class="keyword">if</span> (pipe(p) &lt; <span class="number">0</span>) &#123;<span class="comment">// 建立管道</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Fail to create a pipe\n"</span>);</span><br><span class="line">        _exit(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 将child 1的标准输出作为child 2的标准输入</span></span><br><span class="line">      <span class="keyword">if</span> (fork1() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// child 1:read from stdin(0), write to the right end of pipe(p[1])</span></span><br><span class="line">        <span class="built_in">close</span>(<span class="number">1</span>);<span class="comment">// 关闭标准输出</span></span><br><span class="line">        dup(p[<span class="number">1</span>]);<span class="comment">// 复制管道中fd</span></span><br><span class="line">        <span class="built_in">close</span>(p[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">close</span>(p[<span class="number">1</span>]);</span><br><span class="line">        runcmd(pcmd-&gt;left);<span class="comment">//递归执行左侧命令</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (fork1() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// child 2:read from the left end of pipe(p[0]), write to stdout(1)</span></span><br><span class="line">        <span class="built_in">close</span>(<span class="number">0</span>);</span><br><span class="line">        dup(p[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">close</span>(p[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">close</span>(p[<span class="number">1</span>]);</span><br><span class="line">        runcmd(pcmd-&gt;right);<span class="comment">//递归执行右侧命令</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 关闭不需要的fd</span></span><br><span class="line">      <span class="built_in">close</span>(p[<span class="number">0</span>]);</span><br><span class="line">      <span class="built_in">close</span>(p[<span class="number">1</span>]);</span><br><span class="line">      <span class="comment">// 等待两个子进程结束</span></span><br><span class="line">      wait(&amp;r);</span><br><span class="line">      wait(&amp;r);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  _exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 获取用户输入的命令 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getcmd</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">int</span> nbuf)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isatty(fileno(<span class="built_in">stdin</span>))) <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"&gt; "</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, nbuf);</span><br><span class="line">  <span class="keyword">if</span> (fgets(buf, nbuf, <span class="built_in">stdin</span>) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;  <span class="comment">// EOF</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcmp</span>(buf, <span class="string">"exit\n"</span>) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">//添加退出命令</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">  <span class="keyword">int</span> fd, r;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read and run input commands.</span></span><br><span class="line">  <span class="keyword">while</span> (getcmd(buf, <span class="keyword">sizeof</span>(buf)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'c'</span> &amp;&amp; buf[<span class="number">1</span>] == <span class="string">'d'</span> &amp;&amp; buf[<span class="number">2</span>] == <span class="string">' '</span>) &#123;</span><br><span class="line">      <span class="comment">// Clumsy but will have to do for now.</span></span><br><span class="line">      <span class="comment">// Chdir has no effect on the parent if run in the child.</span></span><br><span class="line">      buf[<span class="built_in">strlen</span>(buf) - <span class="number">1</span>] = <span class="number">0</span>;  <span class="comment">// chop \n</span></span><br><span class="line">      <span class="keyword">if</span> (chdir(buf + <span class="number">3</span>) &lt; <span class="number">0</span>) <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"cannot cd %s\n"</span>, buf + <span class="number">3</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fork1() == <span class="number">0</span>) runcmd(parsecmd(buf)); <span class="comment">//创建一个shell进程的copy，并执行指令</span></span><br><span class="line">    wait(&amp;r); <span class="comment">//shell进入等待状态</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 新开进程 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fork1</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> pid;</span><br><span class="line"></span><br><span class="line">  pid = fork();</span><br><span class="line">  <span class="keyword">if</span> (pid == <span class="number">-1</span>) perror(<span class="string">"fork"</span>);</span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct cmd *<span class="title">execcmd</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">execcmd</span> *<span class="title">cmd</span>;</span></span><br><span class="line"></span><br><span class="line">  cmd = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*cmd));</span><br><span class="line">  <span class="built_in">memset</span>(cmd, <span class="number">0</span>, <span class="keyword">sizeof</span>(*cmd));</span><br><span class="line">  cmd-&gt;type = <span class="string">' '</span>;</span><br><span class="line">  <span class="keyword">return</span> (struct cmd *)cmd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct cmd *<span class="title">redircmd</span><span class="params">(struct cmd *subcmd, <span class="keyword">char</span> *file, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">redircmd</span> *<span class="title">cmd</span>;</span></span><br><span class="line"></span><br><span class="line">  cmd = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*cmd));</span><br><span class="line">  <span class="built_in">memset</span>(cmd, <span class="number">0</span>, <span class="keyword">sizeof</span>(*cmd));</span><br><span class="line">  cmd-&gt;type = type;</span><br><span class="line">  cmd-&gt;cmd = subcmd;</span><br><span class="line">  cmd-&gt;file = file;</span><br><span class="line">  cmd-&gt;flags = (type == <span class="string">'&lt;'</span>) ? O_RDONLY : O_WRONLY | O_CREAT | O_TRUNC;</span><br><span class="line">  cmd-&gt;fd = (type == <span class="string">'&lt;'</span>) ? <span class="number">0</span> : <span class="number">1</span>; <span class="comment">//判断重定向方向，方便后续关闭标准I/O的fd</span></span><br><span class="line">  <span class="keyword">return</span> (struct cmd *)cmd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct cmd *<span class="title">pipecmd</span><span class="params">(struct cmd *left, struct cmd *right)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pipecmd</span> *<span class="title">cmd</span>;</span></span><br><span class="line"></span><br><span class="line">  cmd = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(*cmd));</span><br><span class="line">  <span class="built_in">memset</span>(cmd, <span class="number">0</span>, <span class="keyword">sizeof</span>(*cmd));</span><br><span class="line">  cmd-&gt;type = <span class="string">'|'</span>;</span><br><span class="line">  cmd-&gt;left = left;</span><br><span class="line">  cmd-&gt;right = right;</span><br><span class="line">  <span class="keyword">return</span> (struct cmd *)cmd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parsing</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> whitespace[] = <span class="string">" \t\r\n\v"</span>;</span><br><span class="line"><span class="keyword">char</span> symbols[] = <span class="string">"&lt;|&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gettoken</span><span class="params">(<span class="keyword">char</span> **ps, <span class="keyword">char</span> *es, <span class="keyword">char</span> **q, <span class="keyword">char</span> **eq)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *s;</span><br><span class="line">  <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">  s = *ps;</span><br><span class="line">  <span class="keyword">while</span> (s &lt; es &amp;&amp; <span class="built_in">strchr</span>(whitespace, *s)) s++;</span><br><span class="line">  <span class="keyword">if</span> (q) *q = s;</span><br><span class="line">  ret = *s;</span><br><span class="line">  <span class="keyword">switch</span> (*s) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'|'</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'&lt;'</span>:</span><br><span class="line">      s++;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'&gt;'</span>:</span><br><span class="line">      s++;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      ret = <span class="string">'a'</span>;</span><br><span class="line">      <span class="keyword">while</span> (s &lt; es &amp;&amp; !<span class="built_in">strchr</span>(whitespace, *s) &amp;&amp; !<span class="built_in">strchr</span>(symbols, *s)) s++;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (eq) *eq = s;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (s &lt; es &amp;&amp; <span class="built_in">strchr</span>(whitespace, *s)) s++;</span><br><span class="line">  *ps = s;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">peek</span><span class="params">(<span class="keyword">char</span> **ps, <span class="keyword">char</span> *es, <span class="keyword">char</span> *toks)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *s;</span><br><span class="line"></span><br><span class="line">  s = *ps;</span><br><span class="line">  <span class="keyword">while</span> (s &lt; es &amp;&amp; <span class="built_in">strchr</span>(whitespace, *s)) s++;</span><br><span class="line">  *ps = s;</span><br><span class="line">  <span class="keyword">return</span> *s &amp;&amp; <span class="built_in">strchr</span>(toks, *s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct cmd *<span class="title">parseline</span><span class="params">(<span class="keyword">char</span> **, <span class="keyword">char</span> *)</span></span>;</span><br><span class="line"><span class="function">struct cmd *<span class="title">parsepipe</span><span class="params">(<span class="keyword">char</span> **, <span class="keyword">char</span> *)</span></span>;</span><br><span class="line"><span class="function">struct cmd *<span class="title">parseexec</span><span class="params">(<span class="keyword">char</span> **, <span class="keyword">char</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// make a copy of the characters in the input buffer, starting from s through</span></span><br><span class="line"><span class="comment">// es. null-terminate the copy to make it a string.</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">mkcopy</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">char</span> *es)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> n = es - s;</span><br><span class="line">  <span class="keyword">char</span> *c = <span class="built_in">malloc</span>(n + <span class="number">1</span>);</span><br><span class="line">  assert(c);</span><br><span class="line">  <span class="built_in">strncpy</span>(c, s, n);</span><br><span class="line">  c[n] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 解析命令 */</span></span><br><span class="line"><span class="function">struct cmd *<span class="title">parsecmd</span><span class="params">(<span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *es;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cmd</span> *<span class="title">cmd</span>;</span></span><br><span class="line"></span><br><span class="line">  es = s + <span class="built_in">strlen</span>(s);</span><br><span class="line">  cmd = parseline(&amp;s, es);</span><br><span class="line">  <span class="built_in">peek</span>(&amp;s, es, <span class="string">""</span>);</span><br><span class="line">  <span class="keyword">if</span> (s != es) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"leftovers: %s\n"</span>, s);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cmd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct cmd *<span class="title">parseline</span><span class="params">(<span class="keyword">char</span> **ps, <span class="keyword">char</span> *es)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cmd</span> *<span class="title">cmd</span>;</span></span><br><span class="line">  cmd = parsepipe(ps, es);</span><br><span class="line">  <span class="keyword">return</span> cmd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct cmd *<span class="title">parsepipe</span><span class="params">(<span class="keyword">char</span> **ps, <span class="keyword">char</span> *es)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cmd</span> *<span class="title">cmd</span>;</span></span><br><span class="line"></span><br><span class="line">  cmd = parseexec(ps, es);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">peek</span>(ps, es, <span class="string">"|"</span>)) &#123;</span><br><span class="line">    gettoken(ps, es, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    cmd = pipecmd(cmd, parsepipe(ps, es));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cmd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct cmd *<span class="title">parseredirs</span><span class="params">(struct cmd *cmd, <span class="keyword">char</span> **ps, <span class="keyword">char</span> *es)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> tok;</span><br><span class="line">  <span class="keyword">char</span> *q, *eq;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">peek</span>(ps, es, <span class="string">"&lt;&gt;"</span>)) &#123;</span><br><span class="line">    tok = gettoken(ps, es, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (gettoken(ps, es, &amp;q, &amp;eq) != <span class="string">'a'</span>) &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"missing file for redirection\n"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (tok) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'&lt;'</span>:</span><br><span class="line">        cmd = redircmd(cmd, mkcopy(q, eq), <span class="string">'&lt;'</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'&gt;'</span>:</span><br><span class="line">        cmd = redircmd(cmd, mkcopy(q, eq), <span class="string">'&gt;'</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cmd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">struct cmd *<span class="title">parseexec</span><span class="params">(<span class="keyword">char</span> **ps, <span class="keyword">char</span> *es)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *q, *eq;</span><br><span class="line">  <span class="keyword">int</span> tok, argc;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">execcmd</span> *<span class="title">cmd</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">cmd</span> *<span class="title">ret</span>;</span></span><br><span class="line"></span><br><span class="line">  ret = execcmd();</span><br><span class="line">  cmd = (struct execcmd *)ret;</span><br><span class="line"></span><br><span class="line">  argc = <span class="number">0</span>;</span><br><span class="line">  ret = parseredirs(ret, ps, es);</span><br><span class="line">  <span class="keyword">while</span> (!<span class="built_in">peek</span>(ps, es, <span class="string">"|"</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((tok = gettoken(ps, es, &amp;q, &amp;eq)) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (tok != <span class="string">'a'</span>) &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"syntax error\n"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cmd-&gt;argv[argc] = mkcopy(q, eq);</span><br><span class="line">    argc++;</span><br><span class="line">    <span class="keyword">if</span> (argc &gt;= MAXARGS) &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"too many args\n"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ret = parseredirs(ret, ps, es);</span><br><span class="line">  &#125;</span><br><span class="line">  cmd-&gt;argv[argc] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="task-7-多线程题目"><a class="markdownIt-Anchor" href="#task-7-多线程题目"></a> Task 7+ 多线程题目</h1>
<h2 id="71-pi1c-task7"><a class="markdownIt-Anchor" href="#71-pi1c-task7"></a> 7.1 pi1.c (Task7)</h2>
<p>使用2个线程根据莱布尼兹级数计算PI：</p>
<ul>
<li>莱布尼兹级数公式: 1 - 1/3 + 1/5 - 1/7 + 1/9 - … = PI/4</li>
<li>主线程创建1个辅助线程</li>
<li>主线程计算级数的前半部分</li>
<li>辅助线程计算级数的后半部分</li>
<li>主线程等待辅助线程运行結束后,将前半部分和后半部分相加</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUMBER 0x7ffffff  <span class="comment">//此值越大，PI越精确</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> worker_output;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">worker</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; NUMBER / <span class="number">2</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">2</span>) &#123;</span><br><span class="line">      worker_output += <span class="number">1.0</span> / (<span class="number">2</span> * i - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      worker_output -= <span class="number">1.0</span> / (<span class="number">2</span> * i - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> master_output;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">master</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = NUMBER / <span class="number">2</span> + <span class="number">1</span>; i &lt;= NUMBER; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">2</span>) &#123;</span><br><span class="line">      master_output += <span class="number">1.0</span> / (<span class="number">2</span> * i - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      master_output -= <span class="number">1.0</span> / (<span class="number">2</span> * i - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">pthread_t</span> worker_tid;</span><br><span class="line">  <span class="keyword">double</span> total, PI;</span><br><span class="line"></span><br><span class="line">  pthread_create(&amp;worker_tid, <span class="literal">NULL</span>, worker, <span class="literal">NULL</span>);</span><br><span class="line">  master();</span><br><span class="line">  pthread_join(worker_tid, <span class="literal">NULL</span>);</span><br><span class="line">  total = master_output + worker_output;</span><br><span class="line">  PI = total * <span class="number">4</span>;</span><br><span class="line">  <span class="comment">// printf("master_output = %lf, worker_output = %lf, total = %lf\n",</span></span><br><span class="line">  <span class="comment">// master_output, worker_output, total);</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"PI: %lf\n"</span>, PI);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="72-pi2c-task7"><a class="markdownIt-Anchor" href="#72-pi2c-task7"></a> 7.2  pi2.c (Task7)</h2>
<p>使用N个线程根据莱布尼兹级数计算PI：</p>
<ul>
<li>与上一题类似，但本题更加通用化，能适应N个核心</li>
<li>主线程创建N个辅助线程</li>
<li>每个辅助线程计算一部分任务，并将结果返回</li>
<li>主线程等待N个辅助线程运行结束，将所有辅助线程的结果累加</li>
<li>本题要求 1: 使用线程参数，消除程序中的代码重复</li>
<li>本题要求 2: 不能使用全局变量存储线程返回值</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// int array[] = &#123;1, 1, 1, 2, 2, 2&#125;;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NR_TOTAL 0x7ffff</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NR_CPU 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NR_CHILD (NR_TOTAL / NR_CPU)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">param</span> &#123;</span></span><br><span class="line"><span class="comment">//   int *array;</span></span><br><span class="line">  <span class="keyword">int</span> start;</span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">end</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">result</span> &#123;</span></span><br><span class="line">  <span class="keyword">double</span> sum;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">compute</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">param</span> *<span class="title">param</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">result</span> *<span class="title">result</span>;</span></span><br><span class="line">  <span class="keyword">float</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">  param = (struct param *)arg;</span><br><span class="line">  <span class="keyword">for</span> (i = param-&gt;start; i &lt; param-&gt;<span class="built_in">end</span>; i++)</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">2</span>)</span><br><span class="line">      sum -= <span class="number">1.0</span> / (i * <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      sum += <span class="number">1.0</span> / (i * <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  result = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct result));</span><br><span class="line">  result-&gt;sum = sum;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">pthread_t</span> workers[NR_CPU];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">param</span> <span class="title">params</span>[<span class="title">NR_CPU</span>];</span></span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NR_CPU; i++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">param</span> *<span class="title">param</span>;</span></span><br><span class="line">    param = &amp;params[i];</span><br><span class="line">    <span class="comment">// param-&gt;array = array;</span></span><br><span class="line">    param-&gt;start = i * NR_CHILD;</span><br><span class="line">    param-&gt;<span class="built_in">end</span> = (i + <span class="number">1</span>) * NR_CHILD;</span><br><span class="line">    pthread_create(&amp;workers[i], <span class="literal">NULL</span>, compute, param);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NR_CPU; i++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">result</span> *<span class="title">result</span>;</span></span><br><span class="line">    pthread_join(workers[i], (<span class="keyword">void</span> **)&amp;result);</span><br><span class="line">    sum += result-&gt;sum;</span><br><span class="line">    <span class="built_in">free</span>(result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">double</span> PI = sum * <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"PI: %lf\n"</span>, PI);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="73-sortctask-8"><a class="markdownIt-Anchor" href="#73-sortctask-8"></a> 7.3 sort.c(Task 8)</h2>
<p>多线程排序</p>
<ul>
<li>主线程创建两个辅助线程</li>
<li>辅助线程1使用选择排序算法对数组的前半部分排序</li>
<li>辅助线程2使用选择排序算法对数组的后半部分排序</li>
<li>主线程等待辅助线程运行結束后,使用归并排序算法归并子线程的计算结果</li>
<li>本题要求 1: 使用线程参数，消除程序中的代码重复</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">array</span>[] = &#123;<span class="number">2</span>, <span class="number">-1</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> sorted_array[] = &#123;<span class="number">2</span>, <span class="number">-1</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NR_TOTAL 6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NR_CPU 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NR_CHILD (NR_TOTAL / NR_CPU)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">param</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> *<span class="built_in">array</span>;</span><br><span class="line">  <span class="keyword">int</span> start;</span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">end</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">result</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> sum;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">compute</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">param</span> *<span class="title">param</span>;</span></span><br><span class="line">  param = (struct param *)arg;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = param-&gt;start; i &lt; param-&gt;<span class="built_in">end</span> - <span class="number">1</span>; i++) &#123;  <span class="comment">//选择排序</span></span><br><span class="line">    <span class="keyword">int</span> k = i;                                           <span class="comment">//最小值索引</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; param-&gt;<span class="built_in">end</span>; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (param-&gt;<span class="built_in">array</span>[j] &lt; param-&gt;<span class="built_in">array</span>[k]) &#123;</span><br><span class="line">        k = j;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (k != i) &#123;  <span class="comment">//交换</span></span><br><span class="line">      <span class="keyword">int</span> temp;</span><br><span class="line">      temp = <span class="built_in">array</span>[i];</span><br><span class="line">      <span class="built_in">array</span>[i] = <span class="built_in">array</span>[k];</span><br><span class="line">      <span class="built_in">array</span>[k] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">pthread_t</span> workers[NR_CPU];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">param</span> <span class="title">params</span>[<span class="title">NR_CPU</span>];</span></span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NR_CPU; i++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">param</span> *<span class="title">param</span>;</span></span><br><span class="line">    param = &amp;params[i];</span><br><span class="line">    param-&gt;<span class="built_in">array</span> = <span class="built_in">array</span>;</span><br><span class="line">    param-&gt;start = i * NR_CHILD;</span><br><span class="line">    param-&gt;<span class="built_in">end</span> = (i + <span class="number">1</span>) * NR_CHILD;</span><br><span class="line">    pthread_create(&amp;workers[i], <span class="literal">NULL</span>, compute, param);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NR_CPU; i++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">result</span> *<span class="title">result</span>;</span></span><br><span class="line">    pthread_join(workers[i], (<span class="keyword">void</span> **)&amp;result);</span><br><span class="line">    <span class="comment">// sum += result-&gt;sum;</span></span><br><span class="line">    <span class="comment">// free(result);</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//归并排序</span></span><br><span class="line">  <span class="keyword">int</span> p1 = <span class="number">0</span>, p2 = NR_CHILD, p3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> cur;</span><br><span class="line">  <span class="keyword">while</span> (p1 &lt; NR_CHILD || p2 &lt; NR_TOTAL) &#123;</span><br><span class="line">    <span class="keyword">if</span> (p1 == NR_CHILD) &#123;</span><br><span class="line">      cur = <span class="built_in">array</span>[p2++];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p2 == NR_TOTAL) &#123;</span><br><span class="line">      cur = <span class="built_in">array</span>[p1++];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">array</span>[p1] &lt; <span class="built_in">array</span>[p2]) &#123;</span><br><span class="line">      cur = <span class="built_in">array</span>[p1++];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cur = <span class="built_in">array</span>[p2++];</span><br><span class="line">    &#125;</span><br><span class="line">    sorted_array[p3++] = cur;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//输出结果</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NR_TOTAL; i++) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d "</span>, sorted_array[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="74-pc1ctask-9"><a class="markdownIt-Anchor" href="#74-pc1ctask-9"></a> 7.4 pc1.c(Task 9)</h2>
<ul>
<li>系统中有3个线程：生产者、计算者、消费者</li>
<li>系统中有2个容量为4的缓冲区：buffer1、buffer2</li>
<li>生产者生产’a’、‘b’、‘c’、‘d’、‘e’、‘f’、‘g’、'h’八个字符，放入到buffer1</li>
<li>计算者从buffer1取出字符，将小写字符转换为大写字符，放入到buffer2</li>
<li>消费者从buffer2取出字符，将其打印到屏幕上</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CAPACITY 4</span></span><br><span class="line"><span class="keyword">int</span> buffer1[CAPACITY];</span><br><span class="line"><span class="keyword">int</span> buffer2[CAPACITY];</span><br><span class="line"><span class="keyword">int</span> in1, in2;</span><br><span class="line"><span class="keyword">int</span> out1, out2;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">buffer1_is_empty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> in1 == out1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">buffer1_is_full</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (in1 + <span class="number">1</span>) % CAPACITY == out1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_item1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line"></span><br><span class="line">    item = buffer1[out1];</span><br><span class="line">    out1 = (out1 + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">put_item1</span><span class="params">(<span class="keyword">int</span> item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    buffer1[in1] = item;</span><br><span class="line">    in1 = (in1 + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">buffer2_is_empty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> in2 == out2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">buffer2_is_full</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (in2 + <span class="number">1</span>) % CAPACITY == out2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_item2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line"></span><br><span class="line">    item = buffer2[out2];</span><br><span class="line">    out2 = (out2 + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">put_item2</span><span class="params">(<span class="keyword">int</span> item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    buffer2[in2] = item;</span><br><span class="line">    in2 = (in2 + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex1;</span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex2;</span><br><span class="line"><span class="keyword">pthread_cond_t</span> wait_empty_buffer1;</span><br><span class="line"><span class="keyword">pthread_cond_t</span> wait_full_buffer1;</span><br><span class="line"><span class="keyword">pthread_cond_t</span> wait_empty_buffer2;</span><br><span class="line"><span class="keyword">pthread_cond_t</span> wait_full_buffer2;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ITEM_COUNT (CAPACITY * 2)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">consume</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ITEM_COUNT; i++) &#123; </span><br><span class="line">        pthread_mutex_lock(&amp;mutex2);</span><br><span class="line">        <span class="keyword">while</span> (buffer2_is_empty())</span><br><span class="line">            pthread_cond_wait(&amp;wait_full_buffer2, &amp;mutex2);</span><br><span class="line"></span><br><span class="line">        item = get_item2(); </span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"    consume item: %c\n"</span>, item); </span><br><span class="line"></span><br><span class="line">        pthread_cond_signal(&amp;wait_empty_buffer2);</span><br><span class="line">        pthread_mutex_unlock(&amp;mutex2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">calculate</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ITEM_COUNT; i++) &#123; </span><br><span class="line">        pthread_mutex_lock(&amp;mutex1);</span><br><span class="line">        <span class="keyword">while</span> (buffer1_is_empty())</span><br><span class="line">            pthread_cond_wait(&amp;wait_full_buffer1, &amp;mutex1);</span><br><span class="line"></span><br><span class="line">        item = get_item1(); </span><br><span class="line"></span><br><span class="line">        pthread_cond_signal(&amp;wait_empty_buffer1);</span><br><span class="line">        pthread_mutex_unlock(&amp;mutex1);</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;mutex2);</span><br><span class="line">        <span class="keyword">while</span> (buffer2_is_full())</span><br><span class="line">            pthread_cond_wait(&amp;wait_empty_buffer2, &amp;mutex2);</span><br><span class="line">        item = <span class="built_in">toupper</span>(item);</span><br><span class="line">        put_item2(item);</span><br><span class="line">        <span class="comment">// printf("  calculate item: %c\n", item); </span></span><br><span class="line"></span><br><span class="line">        pthread_cond_signal(&amp;wait_full_buffer2);</span><br><span class="line">        pthread_mutex_unlock(&amp;mutex2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">produce</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ITEM_COUNT; i++) &#123; </span><br><span class="line">        pthread_mutex_lock(&amp;mutex1);</span><br><span class="line">        <span class="keyword">while</span> (buffer1_is_full()) </span><br><span class="line">            pthread_cond_wait(&amp;wait_empty_buffer1, &amp;mutex1);</span><br><span class="line"></span><br><span class="line">        item = <span class="string">'a'</span> + i;</span><br><span class="line">        put_item1(item);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"produce item: %c\n"</span>, item); </span><br><span class="line"></span><br><span class="line">        pthread_cond_signal(&amp;wait_full_buffer1);</span><br><span class="line">        pthread_mutex_unlock(&amp;mutex1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">pthread_t</span> consumer_tid;</span><br><span class="line">    <span class="keyword">pthread_t</span> calculate_tid;</span><br><span class="line">    <span class="keyword">pthread_t</span> produce_tid;</span><br><span class="line"></span><br><span class="line">    pthread_mutex_init(&amp;mutex1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_init(&amp;mutex2, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;wait_empty_buffer1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;wait_full_buffer1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;wait_empty_buffer2, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;wait_full_buffer2, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;consumer_tid, <span class="literal">NULL</span>, consume, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;calculate_tid, <span class="literal">NULL</span>, calculate, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;produce_tid, <span class="literal">NULL</span>, produce, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// produce(NULL); </span></span><br><span class="line">    pthread_join(produce_tid, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(calculate_tid, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(consumer_tid, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="75-pc2ctask-10"><a class="markdownIt-Anchor" href="#75-pc2ctask-10"></a> 7.5 pc2.c(Task 10)</h2>
<ul>
<li>功能和前面的实验相同，使用信号量解决</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CAPACITY 4</span></span><br><span class="line"><span class="keyword">int</span> buffer1[CAPACITY];</span><br><span class="line"><span class="keyword">int</span> buffer2[CAPACITY];</span><br><span class="line"><span class="keyword">int</span> in1, in2;</span><br><span class="line"><span class="keyword">int</span> out1, out2;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">buffer1_is_empty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> in1 == out1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">buffer1_is_full</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (in1 + <span class="number">1</span>) % CAPACITY == out1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_item1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line"></span><br><span class="line">    item = buffer1[out1];</span><br><span class="line">    out1 = (out1 + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">put_item1</span><span class="params">(<span class="keyword">int</span> item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    buffer1[in1] = item;</span><br><span class="line">    in1 = (in1 + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">buffer2_is_empty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> in2 == out2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">buffer2_is_full</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (in2 + <span class="number">1</span>) % CAPACITY == out2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_item2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line"></span><br><span class="line">    item = buffer2[out2];</span><br><span class="line">    out2 = (out2 + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">put_item2</span><span class="params">(<span class="keyword">int</span> item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    buffer2[in2] = item;</span><br><span class="line">    in2 = (in2 + <span class="number">1</span>) % CAPACITY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> mutex;</span><br><span class="line">    <span class="keyword">pthread_cond_t</span> cond;</span><br><span class="line">&#125; <span class="keyword">sema_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sema_init</span><span class="params">(<span class="keyword">sema_t</span> *sema, <span class="keyword">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sema-&gt;value = value;</span><br><span class="line">    pthread_mutex_init(&amp;sema-&gt;mutex, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;sema-&gt;cond, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sema_wait</span><span class="params">(<span class="keyword">sema_t</span> *sema)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;sema-&gt;mutex);</span><br><span class="line">    <span class="keyword">while</span> (sema-&gt;value &lt;= <span class="number">0</span>)</span><br><span class="line">        pthread_cond_wait(&amp;sema-&gt;cond, &amp;sema-&gt;mutex);</span><br><span class="line">    sema-&gt;value--;</span><br><span class="line">    pthread_mutex_unlock(&amp;sema-&gt;mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sema_signal</span><span class="params">(<span class="keyword">sema_t</span> *sema)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;sema-&gt;mutex);</span><br><span class="line">    ++sema-&gt;value;</span><br><span class="line">    pthread_cond_signal(&amp;sema-&gt;cond);</span><br><span class="line">    pthread_mutex_unlock(&amp;sema-&gt;mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">sema_t</span> mutex_sema1;</span><br><span class="line"><span class="keyword">sema_t</span> mutex_sema2;</span><br><span class="line"><span class="keyword">sema_t</span> empty_buffer_sema1;</span><br><span class="line"><span class="keyword">sema_t</span> empty_buffer_sema2;</span><br><span class="line"><span class="keyword">sema_t</span> full_buffer_sema1;</span><br><span class="line"><span class="keyword">sema_t</span> full_buffer_sema2;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ITEM_COUNT (CAPACITY * 2)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">consume</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ITEM_COUNT; i++) &#123; </span><br><span class="line">        sema_wait(&amp;full_buffer_sema2);</span><br><span class="line">        sema_wait(&amp;mutex_sema2);</span><br><span class="line"></span><br><span class="line">        item = get_item2();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"    consume item: %c\n"</span>, item); </span><br><span class="line"></span><br><span class="line">        sema_signal(&amp;mutex_sema2);</span><br><span class="line">        sema_signal(&amp;empty_buffer_sema2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">calculate</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ITEM_COUNT; i++) &#123; </span><br><span class="line">        sema_wait(&amp;full_buffer_sema1);</span><br><span class="line">        sema_wait(&amp;mutex_sema1);</span><br><span class="line"></span><br><span class="line">        item = get_item1();</span><br><span class="line">        <span class="comment">// printf("    consume item: %c\n", item); </span></span><br><span class="line"></span><br><span class="line">        sema_signal(&amp;mutex_sema1);</span><br><span class="line">        sema_signal(&amp;empty_buffer_sema1);</span><br><span class="line"></span><br><span class="line">        sema_wait(&amp;empty_buffer_sema2);</span><br><span class="line">        sema_wait(&amp;mutex_sema2);</span><br><span class="line"></span><br><span class="line">        item = <span class="built_in">toupper</span>(item);</span><br><span class="line">        put_item2(item);</span><br><span class="line">        <span class="comment">// printf("  calculate item: %c\n", item); </span></span><br><span class="line"></span><br><span class="line">        sema_signal(&amp;mutex_sema2);</span><br><span class="line">        sema_signal(&amp;full_buffer_sema2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">produce</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ITEM_COUNT; i++) &#123; </span><br><span class="line">        sema_wait(&amp;empty_buffer_sema1);</span><br><span class="line">        sema_wait(&amp;mutex_sema1);</span><br><span class="line"></span><br><span class="line">        item = i + <span class="string">'a'</span>;</span><br><span class="line">        put_item1(item);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"produce item: %c\n"</span>, item); </span><br><span class="line"></span><br><span class="line">        sema_signal(&amp;mutex_sema1);</span><br><span class="line">        sema_signal(&amp;full_buffer_sema1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">pthread_t</span> consumer_tid;</span><br><span class="line">    <span class="keyword">pthread_t</span> calculate_tid;</span><br><span class="line">    <span class="keyword">pthread_t</span> produce_tid;</span><br><span class="line"></span><br><span class="line">    sema_init(&amp;mutex_sema1, <span class="number">1</span>);</span><br><span class="line">    sema_init(&amp;empty_buffer_sema1, CAPACITY - <span class="number">1</span>);</span><br><span class="line">    sema_init(&amp;full_buffer_sema1, <span class="number">0</span>);</span><br><span class="line">    sema_init(&amp;mutex_sema2, <span class="number">1</span>);</span><br><span class="line">    sema_init(&amp;empty_buffer_sema2, CAPACITY - <span class="number">1</span>);</span><br><span class="line">    sema_init(&amp;full_buffer_sema2, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;consumer_tid, <span class="literal">NULL</span>, consume, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;calculate_tid, <span class="literal">NULL</span>, calculate, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;produce_tid, <span class="literal">NULL</span>, produce, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// produce(NULL); </span></span><br><span class="line">    pthread_join(produce_tid, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(calculate_tid, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(consumer_tid, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="task-11考试"><a class="markdownIt-Anchor" href="#task-11考试"></a> Task 11+考试</h1>
<h2 id="112-ringc"><a class="markdownIt-Anchor" href="#112-ringc"></a> 11.2 ring.c</h2>
<p>1、实现线循环</p>
<p>2、创建N个线程</p>
<p>N个线程构成一个环</p>
<p>主线程向T1发送数据0</p>
<p>T1收到数据后，将数据加1，向T2发送数据1</p>
<p>T2收到数据后，将数据加1，向T3发送数据2</p>
<p>T3收到数据后，将数据加1，向T4发送数据3</p>
<p>…</p>
<p>3、创建N个缓冲区</p>
<p>4、每个线程有一个输入缓冲和一个输出缓冲</p>
<p>5、最终的系统结构如下</p>
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-06-25_23-25-39.png" width="250" height="250" alt="图片名称" align="center" id="173">
<p>6、本程序不能使用任何全局变量，如果使用了全局变量，本题没有得分</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOOPCOUNT 25</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">add</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> *num = (<span class="keyword">int</span> *)arg;</span><br><span class="line">    num[<span class="number">1</span>] = num[<span class="number">0</span>] + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> *result = num;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> buff[N][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; N;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        buff[i][<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">        buff[i][<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">pthread_t</span> tids[N];</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; N)</span><br><span class="line">    &#123;</span><br><span class="line">        count++;</span><br><span class="line">        <span class="keyword">if</span>(count == LOOPCOUNT)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"from T[%d]"</span>,i+<span class="number">1</span>);</span><br><span class="line">        pthread_create(&amp;tids[i],<span class="literal">NULL</span>,add,(<span class="keyword">void</span> *)&amp;buff[i]);</span><br><span class="line">        pthread_join(tids[i],<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">int</span> result = buff[i][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        i = (i+<span class="number">1</span>) % N;</span><br><span class="line">        buff[i][<span class="number">0</span>] = result;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"to T[%d] send %d\n"</span>,i+<span class="number">1</span>,result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N 100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFER_CAPACITY 4</span></span><br><span class="line"><span class="keyword">int</span> <span class="built_in">buffer</span>[BUFFER_CAPACITY] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> in = <span class="number">0</span>, out = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">params</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> order;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> mutex;</span><br><span class="line">    <span class="keyword">pthread_cond_t</span> cond;</span><br><span class="line">&#125; <span class="keyword">sema_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">sema_t</span> thread_mutex[N];</span><br><span class="line"><span class="keyword">sema_t</span> buffer_mutex;</span><br><span class="line"><span class="keyword">sema_t</span> buffer_full_sema, buffer_empty_sema;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sema_init</span><span class="params">(<span class="keyword">sema_t</span> *sema, <span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">    sema-&gt;value = value;</span><br><span class="line">    pthread_mutex_init(&amp;sema-&gt;mutex, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;sema-&gt;cond, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sema_wait</span><span class="params">(<span class="keyword">sema_t</span> *sema)</span> </span>&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;sema-&gt;mutex);</span><br><span class="line">    <span class="keyword">while</span> (sema-&gt;value &lt;= <span class="number">0</span>) </span><br><span class="line">        pthread_cond_wait(&amp;sema-&gt;cond, &amp;sema-&gt;mutex);</span><br><span class="line">    sema-&gt;value--;</span><br><span class="line">    pthread_mutex_unlock(&amp;sema-&gt;mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sema_signal</span><span class="params">(<span class="keyword">sema_t</span> *sema)</span> </span>&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;sema-&gt;mutex);</span><br><span class="line">    ++sema-&gt;value;</span><br><span class="line">    pthread_cond_signal(&amp;sema-&gt;cond);</span><br><span class="line">    pthread_mutex_unlock(&amp;sema-&gt;mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_item</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line">    item = <span class="built_in">buffer</span>[out];</span><br><span class="line">    out = (out + <span class="number">1</span>) % BUFFER_CAPACITY;</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">put_item</span><span class="params">(<span class="keyword">char</span> item)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">buffer</span>[in] = item;</span><br><span class="line">    in = (in + <span class="number">1</span>) % BUFFER_CAPACITY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">instance</span> <span class="params">(<span class="keyword">void</span> *args)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">params</span> *<span class="title">param</span> = (<span class="title">struct</span> <span class="title">params</span> *)<span class="title">args</span>;</span></span><br><span class="line">    <span class="keyword">int</span> item;</span><br><span class="line">    <span class="keyword">int</span> i = param-&gt;order;</span><br><span class="line">    <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        sema_wait(&amp;thread_mutex[i]);</span><br><span class="line">        sema_wait(&amp;buffer_full_sema);</span><br><span class="line">        sema_wait(&amp;buffer_mutex);</span><br><span class="line"></span><br><span class="line">        item = get_item();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\033[0;32m%d get item: %d\033[0m\n"</span>, i+<span class="number">1</span>, item);</span><br><span class="line"></span><br><span class="line">        put_item(++item);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\033[0;31m%d put item: %d\033[0m\n"</span>, i+<span class="number">1</span>, item);</span><br><span class="line"></span><br><span class="line">        sema_signal(&amp;buffer_mutex);</span><br><span class="line">        sema_signal(&amp;buffer_full_sema);</span><br><span class="line">        sema_signal(&amp;thread_mutex[(i+<span class="number">1</span>) % N]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// The first thread</span></span><br><span class="line">        sema_wait(&amp;buffer_empty_sema);</span><br><span class="line">        sema_wait(&amp;buffer_mutex);</span><br><span class="line">        item = i + <span class="number">1</span>;</span><br><span class="line">        put_item(item);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\033[0;31m%d put item: %d\033[0m\n"</span>, i+<span class="number">1</span>, item);</span><br><span class="line">        sema_signal(&amp;buffer_mutex);</span><br><span class="line">        sema_signal(&amp;buffer_full_sema);</span><br><span class="line">        sema_signal(&amp;thread_mutex[(i+<span class="number">1</span>) % N]);</span><br><span class="line"></span><br><span class="line">        sema_wait(&amp;thread_mutex[i]);</span><br><span class="line">        sema_wait(&amp;buffer_full_sema);</span><br><span class="line">        sema_wait(&amp;buffer_mutex);</span><br><span class="line">        item = get_item();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\033[0;32m%d get item: %d\033[0m\n"</span>, i+<span class="number">1</span>, item);</span><br><span class="line">        sema_signal(&amp;buffer_mutex);</span><br><span class="line">        sema_signal(&amp;buffer_empty_sema);</span><br><span class="line">        sema_signal(&amp;thread_mutex[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thread[N];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">params</span> <span class="title">params</span>[<span class="title">N</span>];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">params</span> *<span class="title">param</span> = <span class="title">params</span>;</span></span><br><span class="line"></span><br><span class="line">    sema_init(&amp;buffer_mutex, <span class="number">1</span>);</span><br><span class="line">    sema_init(&amp;buffer_full_sema, <span class="number">0</span>);</span><br><span class="line">    sema_init(&amp;buffer_empty_sema, BUFFER_CAPACITY - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        sema_init(&amp;thread_mutex[i], <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++, param++) &#123;</span><br><span class="line">        param-&gt;order = i;</span><br><span class="line">        pthread_create(&amp;thread[i], <span class="literal">NULL</span>, instance, param);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pthread_join(thread[<span class="number">0</span>], <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="112-多消费者多生产者"><a class="markdownIt-Anchor" href="#112-多消费者多生产者"></a> 11.2 多消费者+多生产者</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//现有一个水果盘，一次只能放一个水果</span></span><br><span class="line"><span class="comment">//父亲一次向里边放一个苹果，母亲一次向里边放一个橘子</span></span><br><span class="line"><span class="comment">//儿子一次从盘中取出一个苹果，女儿一次从盘中取出一个橘子</span></span><br><span class="line"><span class="comment">//要求只能使用条件变量，不能使用环境变量</span></span><br><span class="line"><span class="comment">//输出结果为</span></span><br><span class="line"><span class="comment">//put apple</span></span><br><span class="line"><span class="comment">//get apple</span></span><br><span class="line"><span class="comment">//put orange</span></span><br><span class="line"><span class="comment">//get orange</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> plane = <span class="number">1</span>;<span class="comment">//1表示盘子空 0表示盘子满</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex;</span><br><span class="line"><span class="keyword">pthread_cond_t</span> wait_apple;</span><br><span class="line"><span class="keyword">pthread_cond_t</span> wait_empty;</span><br><span class="line"><span class="keyword">pthread_cond_t</span> wait_orange;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">father_entry</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//while(1)&#123;</span></span><br><span class="line">		pthread_mutex_lock(&amp;mutex);</span><br><span class="line">		<span class="keyword">while</span>(plane == <span class="number">0</span>)</span><br><span class="line">			pthread_cond_wait(&amp;wait_empty, &amp;mutex);</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"put apple"</span>);</span><br><span class="line">		pthread_cond_signal(&amp;wait_apple);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">		plane = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">		pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mother_entry</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//while(1)&#123;</span></span><br><span class="line">		pthread_mutex_lock(&amp;mutex);</span><br><span class="line">		<span class="keyword">while</span>(plane == <span class="number">0</span>)</span><br><span class="line">			pthread_cond_wait(&amp;wait_empty, &amp;mutex);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"put orange"</span>);</span><br><span class="line">		pthread_cond_signal(&amp;wait_orange);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">		plane = <span class="number">0</span>;</span><br><span class="line">		</span><br><span class="line">		pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">		</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">son_entry</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//while(1)&#123;</span></span><br><span class="line">		pthread_mutex_lock(&amp;mutex);</span><br><span class="line">		<span class="keyword">while</span>(plane == <span class="number">1</span>)</span><br><span class="line">			pthread_cond_wait(&amp;wait_apple, &amp;mutex);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"get apple"</span>);</span><br><span class="line">		pthread_cond_signal(&amp;wait_empty);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">		plane = <span class="number">1</span>;</span><br><span class="line">		</span><br><span class="line">		pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">		</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">daughter_entry</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//while(1)&#123;</span></span><br><span class="line">		pthread_mutex_lock(&amp;mutex);</span><br><span class="line">		<span class="keyword">while</span>(plane == <span class="number">1</span>)</span><br><span class="line">			pthread_cond_wait(&amp;wait_orange, &amp;mutex);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"get orange"</span>);</span><br><span class="line">		pthread_cond_signal(&amp;wait_empty);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">		plane = <span class="number">1</span>;</span><br><span class="line">		</span><br><span class="line">		pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">		</span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> father_thread;</span><br><span class="line">    <span class="keyword">pthread_t</span> mother_thread;</span><br><span class="line">    <span class="keyword">pthread_t</span> son_thread;</span><br><span class="line">    <span class="keyword">pthread_t</span> daughter_thread;</span><br><span class="line">	</span><br><span class="line">	pthread_mutex_init(&amp;mutex, <span class="literal">NULL</span>);</span><br><span class="line">	pthread_cond_init(&amp;wait_empty, <span class="literal">NULL</span>);</span><br><span class="line">	pthread_cond_init(&amp;wait_apple, <span class="literal">NULL</span>);</span><br><span class="line">	pthread_cond_init(&amp;wait_orange, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;father_thread, <span class="literal">NULL</span>, &amp;father_entry, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;mother_thread, <span class="literal">NULL</span>, &amp;mother_entry, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;son_thread, <span class="literal">NULL</span>, &amp;son_entry, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;daughter_thread, <span class="literal">NULL</span>, &amp;daughter_entry, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(father_thread,<span class="literal">NULL</span>);</span><br><span class="line">	pthread_join(mother_thread,<span class="literal">NULL</span>);</span><br><span class="line">	pthread_join(son_thread,<span class="literal">NULL</span>);</span><br><span class="line">	pthread_join(daughter_thread,<span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">//while (1);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//现有一个水果盘，一次只能放一个水果</span></span><br><span class="line"><span class="comment">//父亲一次向里边放一个苹果，母亲一次向里边放一个橘子</span></span><br><span class="line"><span class="comment">//儿子一次从盘中取出一个苹果，女儿一次从盘中取出一个橘子</span></span><br><span class="line"><span class="comment">//要求只能使用条件变量，不能使用环境变量</span></span><br><span class="line"><span class="comment">//输出结果为</span></span><br><span class="line"><span class="comment">//put apple</span></span><br><span class="line"><span class="comment">//get apple</span></span><br><span class="line"><span class="comment">//put orange</span></span><br><span class="line"><span class="comment">//get orange</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// int plane = 1;//1表示盘子空 0表示盘子满</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> mutex;</span><br><span class="line">    <span class="keyword">pthread_cond_t</span> cond;</span><br><span class="line">&#125; <span class="keyword">sema_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sema_init</span><span class="params">(<span class="keyword">sema_t</span> *sema, <span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">    sema-&gt;value = value;</span><br><span class="line">    pthread_mutex_init(&amp;sema-&gt;mutex, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_cond_init(&amp;sema-&gt;cond, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sema_wait</span><span class="params">(<span class="keyword">sema_t</span> *sema)</span> </span>&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;sema-&gt;mutex);</span><br><span class="line">    <span class="keyword">while</span> (sema-&gt;value &lt;= <span class="number">0</span>) </span><br><span class="line">        pthread_cond_wait(&amp;sema-&gt;cond, &amp;sema-&gt;mutex);</span><br><span class="line">    sema-&gt;value--;</span><br><span class="line">    pthread_mutex_unlock(&amp;sema-&gt;mutex);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sema_signal</span><span class="params">(<span class="keyword">sema_t</span> *sema)</span> </span>&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;sema-&gt;mutex);</span><br><span class="line">    ++sema-&gt;value;</span><br><span class="line">    pthread_cond_signal(&amp;sema-&gt;cond);</span><br><span class="line">    pthread_mutex_unlock(&amp;sema-&gt;mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">sema_t</span> mutex;</span><br><span class="line"><span class="keyword">sema_t</span> apple;</span><br><span class="line"><span class="keyword">sema_t</span> plate;</span><br><span class="line"><span class="keyword">sema_t</span> orange;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">father_entry</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//while(1)&#123;</span></span><br><span class="line">    sema_wait(&amp;plate);</span><br><span class="line">    sema_wait(&amp;mutex);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"put apple"</span>);</span><br><span class="line">		<span class="comment">// pthread_cond_signal(&amp;wait_apple);</span></span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">		sema_signal(&amp;mutex);</span><br><span class="line">    sema_signal(&amp;apple);</span><br><span class="line">		</span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mother_entry</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//while(1)&#123;</span></span><br><span class="line">    sema_wait(&amp;plate);</span><br><span class="line">    sema_wait(&amp;mutex);</span><br><span class="line">    </span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"put orange"</span>);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">		sema_signal(&amp;mutex);</span><br><span class="line">    sema_signal(&amp;orange);</span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">son_entry</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//while(1)&#123;</span></span><br><span class="line">		sema_wait(&amp;apple);</span><br><span class="line">    sema_wait(&amp;mutex);</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"get apple"</span>);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">		</span><br><span class="line">    sema_signal(&amp;mutex);</span><br><span class="line">    sema_signal(&amp;plate);</span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">daughter_entry</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//while(1)&#123;</span></span><br><span class="line">		sema_wait(&amp;orange);</span><br><span class="line">    sema_wait(&amp;mutex);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"get orange"</span>);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">    sema_signal(&amp;mutex);</span><br><span class="line">    sema_signal(&amp;plate);</span><br><span class="line">		</span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> father_thread;</span><br><span class="line">    <span class="keyword">pthread_t</span> mother_thread;</span><br><span class="line">    <span class="keyword">pthread_t</span> son_thread;</span><br><span class="line">    <span class="keyword">pthread_t</span> daughter_thread;</span><br><span class="line">	</span><br><span class="line">	sema_init(&amp;mutex, <span class="number">1</span>);</span><br><span class="line">  sema_init(&amp;apple, <span class="number">0</span>);</span><br><span class="line">  sema_init(&amp;orange, <span class="number">0</span>);</span><br><span class="line">  sema_init(&amp;plate, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;father_thread, <span class="literal">NULL</span>, &amp;father_entry, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;mother_thread, <span class="literal">NULL</span>, &amp;mother_entry, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;son_thread, <span class="literal">NULL</span>, &amp;son_entry, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;daughter_thread, <span class="literal">NULL</span>, &amp;daughter_entry, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(father_thread,<span class="literal">NULL</span>);</span><br><span class="line">	pthread_join(mother_thread,<span class="literal">NULL</span>);</span><br><span class="line">	pthread_join(son_thread,<span class="literal">NULL</span>);</span><br><span class="line">	pthread_join(daughter_thread,<span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">//while (1);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="随堂作业"><a class="markdownIt-Anchor" href="#随堂作业"></a> 随堂作业</h1>
<h2 id="todo-1-进程的内存布局"><a class="markdownIt-Anchor" href="#todo-1-进程的内存布局"></a> Todo 1 进程的内存布局</h2>
<h3 id="要求"><a class="markdownIt-Anchor" href="#要求"></a> 要求</h3>
<p>一般操作系统中，进程的每个段内部地址均连续，但段与段的相对次序可能不同。用C/C++语言写一个小程序，探测一个操作系统中进程的各段的相对位置(输出次序即可)。</p>
<h3 id="理论基础"><a class="markdownIt-Anchor" href="#理论基础"></a> 理论基础</h3>
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/20190917221359663.png" width="500" height="600" alt="图片名称" align="center" id="174">
<table>
<thead>
<tr>
<th style="text-align:center">栈(stack)</th>
<th style="text-align:left">由编译器自动分配、翻译。存放函数的参数值和局部变量值。操作方式类似数据结构中的栈</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">堆(heap)</td>
<td style="text-align:left">由程序员分配释放。程序员不释放，程序结束时有可能由OS释放。与数据结构中的堆不同，操作方式类似于链表</td>
</tr>
<tr>
<td style="text-align:center">bss</td>
<td style="text-align:left">存放未初始化的全局变量和静态变量</td>
</tr>
<tr>
<td style="text-align:center">数据段data</td>
<td style="text-align:left">存放初始化之后的全局变量、静态变量和常量</td>
</tr>
<tr>
<td style="text-align:center">代码段text</td>
<td style="text-align:left">程序代码主体，函数主体等。注意为二进制格式</td>
</tr>
</tbody>
</table>
<p>Linux 为 C 语言编程环境提供了 3 个全局符号（symbol）：etext、 edata 和 end，可在程序内使用这些符号以获取相应程序文本段、初始化数据段和非初始化数据段结尾处下一字节的地址。</p>
<h3 id="源代码"><a class="markdownIt-Anchor" href="#源代码"></a> 源代码</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> linux</span></span><br><span class="line"><span class="keyword">extern</span> etext, edata, <span class="built_in">end</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> bss_var;        <span class="comment">//未初始化全局变量存储在BSS段</span></span><br><span class="line"><span class="keyword">int</span> data_var = <span class="number">42</span>;  <span class="comment">//初始化全局变量存储在数据段</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> linux</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"etext          address: %p\n"</span>, &amp;etext);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"edata          address: %p\n"</span>, &amp;edata);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"end            address: %p\n"</span>, &amp;<span class="built_in">end</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"main(TEXT)     address: %p\n"</span>, &amp;main);  <span class="comment">//查看代码段main函数位置</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"data_var(DATA) address: %p\n"</span>, &amp;data_var);  <span class="comment">//查看数据段变量地址</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"bss_var(BSS)   address: %p\n"</span>, &amp;bss_var);  <span class="comment">//查看BSS段变量地址</span></span><br><span class="line">  <span class="keyword">char</span> *p;</span><br><span class="line">  p = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">32</span> * <span class="keyword">sizeof</span>(<span class="keyword">char</span>));  <span class="comment">//从堆中分配空间</span></span><br><span class="line">  <span class="keyword">if</span> (p != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"p(HEAP)        address: %p\n"</span>, p);   <span class="comment">//查看堆位置</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"&amp;p(STACK)      address: %p\n"</span>, &amp;p);  <span class="comment">//查看栈位置</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">  <span class="keyword">auto</span> pHeap = (<span class="keyword">char</span> *)GetProcessHeap();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"default heap   address: %p\n"</span>, pHeap);</span><br><span class="line">  HANDLE hHeap = HeapCreate(HEAP_NO_SERIALIZE, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">  <span class="keyword">void</span> *pp = HeapAlloc(hHeap, HEAP_NO_SERIALIZE, <span class="number">1012</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"private heap   address: %p\n"</span>, pp);</span><br><span class="line">  <span class="keyword">auto</span> bRetVal = HeapFree(hHeap, HEAP_NO_SERIALIZE, pp);</span><br><span class="line">  <span class="comment">// sleep(1000); //为方便使用VMMap查看Windows的进程地址空间</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p);  <span class="comment">//释放申请的空间，以避免内存泄露</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="运行结果"><a class="markdownIt-Anchor" href="#运行结果"></a> 运行结果</h3>
<p>下面分别在Linux、windows、macos系统上测试程序：</p>
<h4 id="linuxubuntu-18042-lts"><a class="markdownIt-Anchor" href="#linuxubuntu-18042-lts"></a> Linux(Ubuntu 18.04.2 LTS)</h4>
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_15-41-06.png" width="1000" height="200" alt="图片名称" align="center" id="175">
<p>从打印结果可知：</p>
<ol>
<li>TEXT段在地址 <code>0x7f27358008dd</code> 以下，DATA段的地址范围是：<code>0x7f27358008dd - 0x7f2735a01014</code>，BSS段的地址范围是：<code>0x7f2735a01014 - 0x7f2735a01020</code></li>
<li><code>main</code>的地址为<code>0x7f273580073a</code>，在TEXT段；初始化全局变量<code>data_var</code>的地址为<code>0x7f2735a01010</code>，在DATA段；  未初始化全局变量<code>bss_var</code>的地址为<code>0x7f2735a01018</code>，在 BSS 段内；</li>
<li>char* 变量 p 的值是 <code>0x7fffc693c470</code>，也就是由 malloc() 分配的一块内存空间的首地址，这块内存就在堆中；但是 p 本身存放在栈里，地址为<code>0x7fffce8516e0</code></li>
<li>综上，各段的相对位置(地址由低到高)：TEXT段、DATA段、BSS段、堆、栈。</li>
</ol>
<h4 id="windows-10"><a class="markdownIt-Anchor" href="#windows-10"></a> Windows 10</h4>
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_15-42-26.png" width="1000" height="100" alt="图片名称" align="center" id="176">
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_16-41-10.png" width="1000" height="100" alt="图片名称" align="center" id="177">
<p>从打印结果可知：TEXT段、DATA段、BSS段、栈的相对位置与linux、macos相同，只有堆的位置比较特殊，每次测试结果变化较大。</p>
<p>翻阅《Windows核心编程》：</p>
<ul>
<li>Windows下的堆主要有两种，进程的默认堆和自己创建的私有堆。</li>
<li>在程序启动时，系统在刚刚创建的进程虚拟地址空间中创建一个进程的默认堆，而且程序也可以通过 HeapCreate 函数来调用 ntdll 中的RtlCreateHeap 来创建自己的私有堆，所以一个进程中可以存在多个堆。</li>
<li>Windows下的malloc通过Win32 API HeapAlloc来实现，所以申请的堆空间来自私有堆。</li>
</ul>
<p>推测：</p>
<ul>
<li>
<p>默认堆遵守上面的经典模型，私有堆分配可能比较随意。</p>
</li>
<li>
<p>通过调用<code>GetProcessHeap()</code>来获取默认堆的位置，可能会出现想要的结果。</p>
</li>
</ul>
<p>但是仍然存在上述问题：</p>
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_17-41-36.png" width="1000" height="150" alt="图片名称" align="center" id="178">
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_17-42-17.png" width="1000" height="150" alt="图片名称" align="center" id="179">
<p>最后在知乎上找到了答案：</p>
<blockquote>
<p>Windows的进程地址空间分布跟上面说的简化的Linux/x86模型颇不一样。<br>
就算在没有ASLR的老Windows上也已经很不一样，有了ASLR之后就更加不一样了。</p>
<p>在Windows上不应该对栈和堆的相对位置做任何假设。</p>
<p>要想看个清楚Windows的进程地址空间长啥样，可以用Sysinternals出品的<a href="https://link.zhihu.com/?target=https%3A//technet.microsoft.com/en-us/library/dd535533.aspx" target="_blank" rel="noopener">VMMap</a>看看。</p>
</blockquote>
<p>使用VMMap查看：</p>
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_23-51-54.png" width="1000" height="500" alt="图片名称" align="center" id="180">
<h4 id="macos"><a class="markdownIt-Anchor" href="#macos"></a> macOS</h4>
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/Snipaste_2021-05-09_15-52-50.png" width="1000" height="150" alt="图片名称" align="center" id="181">
<p>从打印结果可知：各段的相对位置(地址由低到高)：TEXT段、DATA段、BSS段、堆、栈。</p>
<h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3>
<p>在简化的32位Linux/x86进程地址空间模型里，（主线程的）栈空间确实比堆空间的地址要高——它已经占据了用户态地址空间的最高可分配的区域，并且向下（向低地址）增长。借用Gustavo Duarte的<a href="https://link.zhihu.com/?target=http%3A//duartes.org/gustavo/blog/post/anatomy-of-a-program-in-memory/" target="_blank" rel="noopener">Anatomy of a Program in Memory</a>里的图：</p>
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/215522854f166f7b5a537ccfa641c922_r.jpg" width="500" height="500" alt="图片名称" align="center" id="182">
<p>《程序员的自我修养》也说<code>栈的地址比堆高，栈是向下增长的，堆是向上增长的。</code> 这个说法其实不够严谨。而且上图是简化模型，会有特例：</p>
<ol>
<li>虽然传统上，Linux上的malloc实现会使用<code>brk()/sbrk()</code>（这俩构成了上图中<code>Heap</code>所示的部分，这也是Linux自身所认为是heap的地方，用pmap可以看到这里被标记为[heap]），但这并不是必须的；一个malloc()完全可以只用或基本上只用mmap()来实现，此时一般说的“Heap”（malloc-heap）就不一定在上图<code>Heap</code>（Linux heap）所示部分，而会在<code>Memory Mapping Segment</code>部分散布开来。不同版本的Linux在分配未指定起始地址的mmap()时用的顺序不一样，并不保证某种顺序。<strong>而且mmap()分配到的空间是有可能出现在低于主可执行程序映射进来的<code>text Segment</code>所在的位置。</strong></li>
<li>Linux上多线程进程中，“线程”其实是一组共享虚拟地址空间的进程。只有主线程的栈是按照上面图示分布，其它线程的栈的位置其实是“随机”的——它们可以由pthread_create()调用mmap()来分配，也可以由程序自己调用mmap()之后把地址传给pthread_create()。既然是mmap()来的，其它线程的栈出现在<code>Memory Mapping Segment</code>的任意位置都不出奇，与用于实现malloc()用的mmap()空间很可能是交错出现的。</li>
</ol>
<p>至于Windows的进程地址空间分布跟上面说的简化的Linux/x86模型颇不一样。就算在没有ASLR的老Windows上也已经很不一样，有了ASLR之后就更加不一样了。</p>
<p>在Windows上不应该对栈和堆的相对位置做任何假设。</p>
<p>要想看清楚Windows的进程地址空间布局，可以用Sysinternals出品的<a href="https://link.zhihu.com/?target=https%3A//technet.microsoft.com/en-us/library/dd535533.aspx" target="_blank" rel="noopener">VMMap</a>看看。</p>
<h3 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h3>
<ul>
<li><a href="https://blog.csdn.net/weixin_43555423/article/details/89319795" target="_blank" rel="noopener">C语言易错点汇总（二）</a></li>
<li><a href="https://blog.csdn.net/ywcpig/article/details/52303745" target="_blank" rel="noopener">程序内存空间（代码段、数据段、堆栈段）</a></li>
<li><a href="https://www.cnblogs.com/zafu/p/7399859.html" target="_blank" rel="noopener">C语言中内存分布及程序运行中(BSS段、数据段、代码段、堆栈）</a></li>
<li><a href="https://blog.csdn.net/u012218838/article/details/77834711" target="_blank" rel="noopener">Windows私有堆的使用</a></li>
<li><a href="https://www.freebuf.com/articles/system/156174.html" target="_blank" rel="noopener">浅析Windows下堆的结构</a></li>
<li><a href="https://www.zhihu.com/question/36103513/answer/66101372" target="_blank" rel="noopener">堆、栈的地址高低？ 栈的增长方向？</a></li>
</ul>
<h2 id="todo-2-进程相关"><a class="markdownIt-Anchor" href="#todo-2-进程相关"></a> Todo 2 进程相关</h2>
<h3 id="一-选择题"><a class="markdownIt-Anchor" href="#一-选择题"></a> 一、选择题</h3>
<ol>
<li>
<p>如果操作系统采用了非抢占式进程调度算法，则进程不可能出现以下哪种状态转换? <strong>B</strong></p>
<blockquote>
<p>A.执行到阻塞 B. 执行到就绪 C. 阻塞到就绪 D. 就绪到执行</p>
</blockquote>
</li>
<li>
<p>进程调度算法在选择进程时，只考虑处于哪个状态的进程? <strong>A</strong></p>
<blockquote>
<p>A.就绪 B.阻塞 C.执行 D.结束</p>
</blockquote>
</li>
<li>
<p>子程序的返回地址一般存在 <strong>A</strong></p>
<blockquote>
<p>A.栈B.堆C.数据段D.代码段</p>
</blockquote>
</li>
<li>
<p>哪个调度算法只有抢占式版本? <strong>D</strong></p>
<blockquote>
<p>A.先到先服务B. 短作业优先C. 优先级调度D. 轮转调度</p>
</blockquote>
</li>
</ol>
<h3 id="二-概念理解及应用"><a class="markdownIt-Anchor" href="#二-概念理解及应用"></a> 二、概念理解及应用</h3>
<h4 id="t14分"><a class="markdownIt-Anchor" href="#t14分"></a> T1(4分)</h4>
<p><strong>问题</strong>：为了解决能够同时服务多个客户的目的,开发人员设计了多线程程序，每次有新用户连接时创建一个新的服务线程，服务结束时销毁线程;同时，为了防止服务器瘫瘓,限制了服务线程的总数量为100个。但是在运行过程中，不断创建销毁线程引入了不必要的额外开销，你有什么办法避免这个开销?你的办法有什么缺点?</p>
<p><strong>解答如下</strong>：</p>
<p>采用线程池，把宝贵的资源放到一个池子中；每次使用都从里面获取，用完之后又放回池子供其他人使用。主要流程图如下：</p>
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/v2-9702bee4c343bce3289401dce83211c0_r.jpg" width="400" height="300" alt="图片名称" align="center" id="183">
<p><strong>优点</strong>：</p>
<ol>
<li>降低资源开销：由于线程是反复利用的，降低了创建线程分配资源和销毁线程的开销。</li>
<li>提高响应速度：由于线程是提前预热的，因此减少了创建线程这段时间的开销。</li>
<li>提高系统资源可管理性：使用线程池统一分配、管理和监控。</li>
</ol>
<p><strong>缺点</strong>：</p>
<ol>
<li>当客户少时浪费资源</li>
<li>一个根本性的缺陷：<strong>连续争用问题</strong>。也就是多个线程在申请任务时，为了合理地分配任务要付出锁资源，对比快速的任务执行来说，这部分申请的损耗是巨大的。</li>
</ol>
<p>参考：<a href="https://zhuanlan.zhihu.com/p/161628226" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/161628226</a></p>
<h4 id="t24分"><a class="markdownIt-Anchor" href="#t24分"></a> T2(4分)</h4>
<p><strong>问题</strong>：《Unix编程艺术》提倡使用多进程编程，而不是多线程编程。你觉得可能的原因是什么?</p>
<p><strong>解答如下</strong>：</p>
<ol>
<li>多进程,本质上就可以避免多线程『共享内存数据』产生的 “corruotped memory” 问题；</li>
<li>多线程的程序非常难以正确的编写；</li>
<li>难以调试: 因为 数据依赖，时间依赖</li>
<li>线程破坏了抽象: 无法设计出模块化的程序</li>
<li>因为锁导致回调无法完成</li>
<li>进程隔离性好，一个进程挂了不影响另外一个进程。</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="http://ifeve.com/why-threads-bad/" target="_blank" rel="noopener">http://ifeve.com/why-threads-bad/</a></li>
<li><a href="https://web.stanford.edu/~ouster/cgi-bin/papers/threads.pdf" target="_blank" rel="noopener">https://web.stanford.edu/~ouster/cgi-bin/papers/threads.pdf</a></li>
</ul>
<h3 id="三-计算题"><a class="markdownIt-Anchor" href="#三-计算题"></a> 三、计算题</h3>
<p>现有3个进程A、B、C到达时间和预计运行时间如下表所示。要求画出不同调度算法下进程运行的甘特图,并计算进程的平均周转时间。</p>
<table>
<thead>
<tr>
<th style="text-align:center">进程编号</th>
<th style="text-align:center">到达时间（毫秒）</th>
<th style="text-align:center">执行时间（毫秒）</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">A</td>
<td style="text-align:center">0</td>
<td style="text-align:center">9</td>
</tr>
<tr>
<td style="text-align:center">B</td>
<td style="text-align:center">1</td>
<td style="text-align:center">7</td>
</tr>
<tr>
<td style="text-align:center">C</td>
<td style="text-align:center">2</td>
<td style="text-align:center">4</td>
</tr>
</tbody>
</table>
<ol>
<li>先到先服务调度算法</li>
<li>短作业优先(非抢占)</li>
<li>抢占式短作业优先算法</li>
<li>时间片轮转算法(时间片为3毫秒)</li>
</ol>
<p><strong>改错</strong>：</p>
<p>T2：A C B 13ms</p>
<img src="https://cdn.jsdelivr.net/gh/Dragonliu2018/FigureBed@master/img/QQ图片20210523195240.jpg" width="1000" height="300" alt="图片名称" align="center" id="184">
<h2 id="todo-3"><a class="markdownIt-Anchor" href="#todo-3"></a> Todo 3</h2>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://Dragonliu2018.github.io/2021/04/05/操作系统实验/" title="操作系统实验" target="_blank" rel="external">https://Dragonliu2018.github.io/2021/04/05/操作系统实验/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/dragonliu2018" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/dragonliu2018" target="_blank"><span class="text-dark">Dragon&#39;s Blogs</span><small class="ml-1x">Nuaa CSer</small></a></h3>
        <div>Life is painting a picture, not doing a sum.</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2021/06/27/Python-全局变量-list/" title="Python-全局变量-list"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/03/04/MAC地址欺骗/" title="MAC地址泛洪与欺骗"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/dragonliu2018" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: 'Pbjl2Wajl9och0xVbR5eqoH1-gzGzoHsz',
    appKey: 'PgxFh1wV6pyMMllhxs7NJijb',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>